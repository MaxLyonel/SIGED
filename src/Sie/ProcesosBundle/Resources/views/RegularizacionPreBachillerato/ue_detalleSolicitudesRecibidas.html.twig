{% extends 'SieProcesosBundle:RegularizacionPreBachillerato:Templates/detalleSolicitudesRecibidas.html.twig' %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		input[type="text"]
		{
			color:inherit !important;
		}
		.notaValida
		{
			/* background-color: #7fb842 !important; */
			border: 2px solid #7fb842 !important;
			/* color: white !important;
			font-weight: bold !important; */
			color: initial !important;
    		font-weight: bold !important;
		}
		.notaNoValida
		{
			/* background-color: #e64328 !important; */
			border: 2px solid #e64328 !important;
			/* color: white !important;
			font-weight: bold !important; */
			color: initial !important;
    		font-weight: bold !important;
		}
	</style>
{% endblock %}
{% block modalRegistrarNotas %}
<!--Modal registrar notas-->
<div class="modal fade" id="modal-register-grade" tabindex="-1" role="dialog" aria-labelledby="modal-registrar-notas">
	<form action="#" method="POST" class="form-register-grade">
		{#<input type="hidden" name="token" value="{{ csrf_token('form-register-grade') }}">#}
		<input type="hidden" name="inscription_id" id="inscription_id" class="inscription-id" value="">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="modal-registrar-mostas">Registrar Calificaciones <span class="span-txt-nombre"></span></h4>
				</div>
				
				<div class="modal-body">
					<div class="div-add-grade">

						<div class="row">
							<div class="col-xs-12">
								<div class="row" style="padding-top:1rem">
									{# <div class="col-xs-12 col-sm-6">
										<div class="form-group">
											<label class="col-xs-12 col-sm-3 control-label">Gestión:</label>
											<div class="col-xs-12 col-sm-9">
												<div class="form-control div-txt-gestion" disabled></div>
											</div>
										</div>
									</div> #}
									<div class="col-xs-12 col-sm-6">
										<div class="form-group">
											<label class="col-xs-12 col-sm-3 control-label">Nivel:</label>
											<div class="col-xs-12 col-sm-9">
												<div class="form-control div-txt-nivel" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;font-size: 10px;" disabled></div>
											</div>
										</div>
									</div>
									<div class="col-xs-12 col-sm-6">
										<div class="form-group">
											<label class="col-xs-12 col-sm-3 control-label">Grado:</label>
											<div class="col-xs-12 col-sm-9">
												<div class="form-control div-txt-grado" disabled></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-xs-12">
								<div class="row" style="padding-top:1rem">
									<div class="col-xs-12 col-sm-6">
										<div class="form-group">
											<label class="col-xs-12 col-sm-3 control-label">Turno:</label>
											<div class="col-xs-12 col-sm-9">
												<select name="register_turno" id="register_turno" class="form-control register-turno" autocomplete="false" required>
													<option value="" class="option-turno">Seleccione el turno</option>
												</select>
											</div>
										</div>
									</div>
									<div class="col-xs-12 col-sm-6">
										<div class="form-group">
											<label class="col-xs-12 col-sm-3 control-label">Paralelo:</label>
											<div class="col-xs-12 col-sm-9">
												<select name="register_paralelo" id="register_paralelo" class="form-control register-paralelo" autocomplete="false" required>
													<option value="" class="option-paralelo">Seleccione el paralelo</option>
												</select>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-xs-12">
								<div class="row" style="padding-top:1rem">
									<div class="col-xs-12 table-responsive" style="height:300px;">
										<table class="table table-striped table-condensed">
											<thead>
												<tr>
													<th scope="col" width="5%">#</th>
													<th scope="col" >Áreas Curriculares</th>
													<th scope="col" width="15%">Calificación</th>
												</tr>
											</thead>
											<tbody class="tbody-grades-assignment">
												<tr><td colspan="7">Seleccione el turno y el paralelo primero</td></tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-success btn-register-grade">Registrar/Actualizar</button>
				</div>
			</div>
		</div>
	</form>
</div>
{% endblock %}					

	{# aqui se recibira el array de inscripciones #}
	{% block seccionTablaInscripciones %}
	<div class="row" style="padding-top:1.5rem">
		<div class="col-xs-12 table-responsive ">
			<table class="table table-striped">
				<thead>
					<tr>
						<th>#</th>
						<th>Inscripción</th>
						{# <th>Gestión</th> #}
						<th>Nivel</th>
						<th>Grado</th>
						<th width="10%">Calificación</th>
						<th width="10%"></th>
					</tr>
				</thead>
				<tbody class="tbody-subject-assignment">
					{% if tablaInscripciones %}
						{% for m in tablaInscripciones %}
						<tr class="regularizacion-materias-inscritas-{{m.id}}" data-id="{{m.id}}">
							<th scope="row">{{loop.index}}</th>
							<td>Inscripción {{loop.index}}</td>
							{# <td class="data-gestion">{{m.gestion}}</td> #}
							<td class="data-nivel">{{m.nivel}}</td>
							<td class="data-grado">{{m.grado}}</td>
							<td class="data-calificacion"> <span class="label label-warning">Sin registro</span> </td>
							<td><button type="button" class="btn btn-success btn-sm btn-register-grade" data-id="{{m.id}}" data-tramite="{{tramite}}" onclick="abrirModalRegistrarCalificaciones(this)"  data-txtNivel='{{m.nivel}}' data-txtGrado='{{m.grado}}' data-txtTitulo='Inscripción {{loop.index}}'>Registrar/actualizar notas</button></td>
						</tr>
						{% endfor %}
					{% else %}
						<tr><td colspan="7">No existen datos de inscripciones</td></tr>
					{% endif %}
				</tbody>
			</table>
		</div>
	</div><!--FIN Tabla inscripcion-->
{% endblock %}

{% block seccionArchivosAdjuntos %}
	{% include 'SieProcesosBundle:RegularizacionPreBachillerato:Fragmentos/frag_seccionArchivosAdjuntos.html.twig' %}
{% endblock %}

{% block seccionCreacionYSubidaDelInforme %}
	<input type="hidden" name="request_tramite" id="request_tramite" value="{{tramite}}">
	{% include 'SieProcesosBundle:RegularizacionPreBachillerato:Fragmentos/frag_seccionYSubidaDelInforme.html.twig' %}
{% endblock %}

{% block seccionBtnEnviar %}
	<div class="row" style="padding-top:1rem">
		<div class="col-xs-12" style="padding-top:1rem">
			<div class="form-group">
				<div class="col-xs-12 col-sm-12">
					{% if error %}
						<div class="alert alert-danger" role="alert">{{error}}</div>
					{% else %}
						<button type="submit" class="btn btn-primary btn-send-request-distrital">Enviar a la Distrital</button>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script type="text/javascript">
		var materiasArray = [];
		
		$('.form-send-request').on('submit',function (e)
		{
			formSendRequest(this,e);
		});

		$('.form-register-grade').on('submit',function (e)
		{
			formRegisterGrade($(this),e);
		});

		$('.tbody-grades-assignment').on('keypress','.only-numbers',function (e)
		{
			var key = window.event ? e.which : e.keyCode;
			if (key >= 48 && key <= 57)
				return true;
			else
				return false;
		});

		$('.tbody-grades-assignment').on('blur','.register-notas',function (e)
		{
			var maxNota = parseInt($(this).attr('data-max'));
			var nota= parseInt($(this).val());
			var notaAprobacion= parseInt($(this).attr('data-aprobacion'));

			if(nota>maxNota)
			{
				$(this).val(maxNota);
				nota= parseInt($(this).val());
			}

			if(nota<=maxNota && nota>= notaAprobacion)
			{
				$(this).addClass('notaValida');
				$(this).removeClass('notaNoValida');
			}
			else
			{
				$(this).removeClass('notaValida');
				$(this).addClass('notaNoValida');
			}
		});

		$('.register-turno').on('change',function(e)
		{
			var tramite = $(this).attr('data-tramite');
			var id = $(this).attr('data-id');
			var turno= $(this).val();
			// console.log(id);
			buscarParalelos(id,tramite,turno,e);
		});

		
		$('.register-paralelo').on('change',function(e)
		{
			var tramite = $(this).attr('data-tramite');
			var id = $(this).attr('data-id');
			var turno= $('.register-turno').val();
			var paralelo= $(this).val();
			buscarMaterias(id,tramite,turno,paralelo,e);
		});
		

		var abrirModal=function(_nombreModal)//codigo repetido se pensara volver en un plantilla
		{
			var modal=$("#"+_nombreModal);
			if(typeof(modal)!=null)
				modal.modal('show');
		}
		var cerrarModal=function(_nombreModal)//codigo repetido se pensara volver en un plantilla
		{
			var modal=$("#"+_nombreModal);
			if(typeof(modal)!=null)
			{
				modal.modal('hide');
				limpiarModal(_nombreModal)
			}
		}
		var ejecutandoAccion=function (_con,_ele,_text)//codigo repetido se pensara volver en un plantilla
		{
			var ele=$('.'+_con).find('.'+_ele);
			if(typeof(ele)!=null)
			{
				ele.text(_text);
			}
		}
		var unserialize=function (serializedData)//codigo repetido se pensara volver en un plantilla
		{	
			/*
			data = data.split('&');
			var response = {};
			for (var k in data)
			{
				var newData = data[k].split('=');
				response[newData[0]] = newData[1];
			}
			return response;
			*/
			var urlParams = new URLSearchParams(serializedData); // get interface / iterator
			unserializedData = {}; // prepare result object
			for ([key, value] of urlParams)// get pair > extract it to key/value
			{
				unserializedData[key] = value;
			}
			return unserializedData;
		}
		var habilitarElemento=function(_con,_ele)//codigo repetido se pensara volver en un plantilla
		{
			var ele=$(_con).find('.'+_ele);
			if(typeof(ele)!=null)
			{
				ele.removeAttr('disabled');
			}
		}
		var deshabilitarElemento=function(_con,_ele)//codigo repetido se pensara volver en un plantilla
		{
			var ele=$(_con).find('.'+_ele);
			if(typeof(ele)!=null)
			{
				ele.attr('disabled',true);
			}
		}
		var limpiarModal=function (_nombreModal)//codigo repetido se pensara volver en un plantilla
		{

			$("#"+_nombreModal).find('form')[0].reset();
		}
		var sanitizarDatos= function (text)//codigo repetido se pensara volver en un plantilla
		{
			//falta sanitizar los datos
			return text;
		}

		var buscarTurno = function (_id,_tramite,_paralelo,e)
		{
			e.preventDefault();
			var option_default='<option value="" class="option-turno">Seleccione el turno</option>';
			var option_error='<option value="" class="option-turno">Acaba de ocurrir un error, por favor vuelva a seleccionar el paralelo</option>';

			if(_paralelo.toString().length<=0 || isNaN(_paralelo))
			{
				$('.register-turno').html(option_default);
				return;
			}
			var form= new FormData();
			form.set('id',_id);
			form.set('tramite',_tramite);
			form.set('paralelo',_paralelo);
			$.ajax({
				type:'post',
				url:"{{path('regularizacion_pre_bachillerato_getTurnos')}}",
				data:form,
				dataType: 'json',
				processData: false,
				contentType: false,
				beforeSend:function(){
					$('.option-turno').html('Buscando turnos ...');
				},
				success:function (data)
				{
					try
					{
						var tmpData = JSON.parse(data.data);
						var turnos = tmpData.turnos;
						if(typeof(turnos)!='undefined')
						{
							var option=option_default;
							$.each(turnos,function(i, item)
							{
								option+="<option value='"+item.id+"'>"+item.turno+"</option>";
							});
							$('.register-turno').html(option);
						}
						else
						{
							$('.register-turno').html(option_error);
						}
					}
					catch(e)
					{
						$('.register-turno').html(option_error);
					}
				},
				error:function()
				{
					$('.register-turno').html(option_default);
					try
					{
						var data 	= JSON.parse(xhr.responseText);
						var msj 	= data.msj;
						var status 	= data.status;
						if(status== 404)
							$('.register-turno').html('<option value="" class="option-turno">'+data.msj+'</option>');
						else
							$('.register-turno').html(option_error);
					}
					catch(e)
					{
						$('.register-turno').html(option_error);
					}
				}
			});
		}

		var buscarParalelos = function (_id,_tramite,_turno,e)
		{
			e.preventDefault();
			var option_default='<option value="" class="option-paralelo">Seleccione el paralelo</option>';
			var option_error='<option value="" class="option-paralelo">Acaba de ocurrir un error, por favor vuelva a seleccionar el turno</option>';

			if(_turno.toString().length<=0 || isNaN(_turno))
			{
				$('.register-paralelo').html(option_default);
				return;
			}
			var form= new FormData();
			form.set('id',_id);
			form.set('tramite',_tramite);
			form.set('turno',_turno);
			$.ajax({
				type:'post',
				url:"{{path('regularizacion_pre_bachillerato_getParalelos')}}",
				data:form,
				dataType: 'json',
				processData: false,
				contentType: false,
				beforeSend:function(){
					$('.option-paralelo').html('Buscando paralelos ...');
				},
				success:function (data)
				{
					try
					{
						var tmpData = JSON.parse(data.data);
						var paralelos = tmpData.paralelos;
						if(typeof(paralelos)!='undefined')
						{
							var option=option_default;
							$.each(paralelos,function(i, item)
							{
								option+="<option value='"+item.id+"'>"+item.paralelo+"</option>";
							});
							$('.register-paralelo').html(option);
						}
						else
						{
							$('.register-paralelo').html(option_error);
						}
					}
					catch(e)
					{
						$('.register-paralelo').html(option_error);
					}
				},
				error:function()
				{
					$('.register-paralelo').html(option_default);
					try
					{
						var data 	= JSON.parse(xhr.responseText);
						var msj 	= data.msj;
						var status 	= data.status;
						if(status== 404)
							$('.register-paralelo').html('<option value="" class="option-paralelo">'+data.msj+'</option>');
						else
							$('.register-paralelo').html(option_error);
					}
					catch(e)
					{
						$('.register-paralelo').html(option_error);
					}
				}
			});
		}

		var buscarMaterias = function (_id,_tramite,_turno,_paralelo,e)
		{	
			// console.log(_id);
			// console.log(_tramite);
			// console.log(_turno);
			// console.log(_paralelo);
			e.preventDefault();
			var option_default='<tr><td colspan="7">Seleccione el turno y el paralelo primero</td></tr>';
			var option_error='<tr><td colspan="7">Acaba de ocurrir un error, por favor vuelva a seleccionar el paralelo.</td></tr>';

			if(_turno.toString().length<=0 || isNaN(_turno))
			{
				alert('Debe seleccionar un turno');
				return;
			}

			if(_paralelo.toString().length<=0 || isNaN(_paralelo))
			{
				alert('Debe seleccionar un paralelo');
				return;
			}
			var form= new FormData();
			form.set('id',_id);
			form.set('tramite',_tramite);
			form.set('turno',_turno);
			form.set('paralelo',_paralelo);
			$.ajax({
				type:'post',
				url:"{{path('regularizacion_pre_bachillerato_getMaterias')}}",
				data:form,
				dataType: 'json',
				processData: false,
				contentType: false,
				beforeSend:function(){
					$('.tbody-grades-assignment').html('<tr><td colspan="7">Cargando Materias ...</td></tr>');
				},
				success:function (data)
				{
					try
					{
						var tmpData = JSON.parse(data.data);
						var materias = tmpData.materias;
						var inscripcion = tmpData.inscripcion;
						if(typeof(materias)!='undefined' && typeof(inscripcion)!='undefined')
						{
							var _inscripcion_id 	= inscripcion.id;
							// var gestion 			= inscripcion.gestion;
							var nivel 				= inscripcion.nivel;
							var grado 				= inscripcion.grado;
							
							
							materiasArray[_inscripcion_id] = materias;
							// if(typeof(gestion)!='undefined' && !isNaN(gestion))
							// {
								// var m = llenarMaterias(materias,'tbody-grades-assignment',_tramite,_id,gestion,nivel,grado);
							// var m = llenarMaterias(materias,'tbody-grades-assignment',_tramite,_id,nivel,grado);
							var m = llenarMaterias(materias,'tbody-grades-assignment',_id);
							// }
							// else
							// {
							// 	$('.tbody-grades-assignment').html(option_error);
							// }
						}
						else
						{
							$('.tbody-grades-assignment').html(option_error);
						}
					}
					catch(e)
					{
						$('.tbody-grades-assignment').html(option_error);
					}
				},
				error:function()
				{
					$('.tbody-grades-assignment').html(option_default);
					try
					{
						var data 	= JSON.parse(xhr.responseText);
						var msj 	= data.msj;
						var status 	= data.status;
						if(status== 404)
							$('.register-paralelo').html('<tr><td colspan="7">'+data.msj+'</td></tr>');
						else
							$('.tbody-grades-assignment').html(option_error);
					}
					catch(e)
					{
						$('.tbody-grades-assignment').html(option_error);
					}
				}
			});
		}
		var llenarDatosInscripcionSiExiste = function(_inscripcion_id)
		{
			var inscripcion = $('#request_materias_'+_inscripcion_id);
			var option_default='<tr><td colspan="7">Seleccione el turno y el paralelo primero</td></tr>';
			// console.log('matarray:'+materiasArray);
			if(typeof(inscripcion)!='undefined')
			{	
				var datos=inscripcion.val();
				try
				{	
					// console.log(datos);
					var json=JSON.parse(datos);
					// console.log('json'+json);
					json=json[_inscripcion_id];
					var paralelo= json.paralelo;
					var turno = json.turno;
					var materias =json.materias;
					if(typeof(turno)!='undefined')
					{
						var tmp=$('.register-turno');
						if(typeof(tmp)!='undefined')
						{
							tmp.val(turno).change(function()
							{
								if(typeof(paralelo)!='undefined')
								{
									let tmp2=$('.register-paralelo');
									if(typeof(tmp2)!='undefined')
									{	
										tmp2.val(paralelo).change();
									}
								}
							});
						}
					}
					if(typeof(paralelo)!='undefined')
					{
						var tmpP=$('.register-paralelo');
						if(typeof(tmpP)!='undefined')
						{
							tmpP.val(paralelo).change(function ()
							{
								//verificarAsignaturaModificada(materias);
								llenarMaterias(materiasArray[_inscripcion_id],'tbody-grades-assignment',_inscripcion_id);
								llenarNotasEnAsigantura(materias);
							});
						}
					}
					if(typeof(materias)!='undefined')
					{
						//verificarAsignaturaModificada(materias);
						llenarMaterias(materiasArray[_inscripcion_id],'tbody-grades-assignment',_inscripcion_id);
						llenarNotasEnAsigantura(materias);
					}
				}
				catch(e)
				{
					inscripcion.val('');
					$('.tbody-grades-assignment').html(option_default);
					cambiarEstadoRegistroNota(_inscripcion_id,0);
				}
			}
		}

		var verificarAsignaturaModificada = function (materias)
		{
			var todasLasAsignaturasHTML = $('.tbody-grades-assignment').find('tr[class^="regularizacion-registrar-notas-"]');
			var todasLasAsignaturasConNota= new Array();

			for (var i=0; i<materias.length;i++)
			{
				var tmp=materias[i];
				if(typeof(tmp)!='undefined')
				{
					if(tmp.hasOwnProperty('id'))
					{
						todasLasAsignaturasConNota.push(tmp.id);
					}
				}
			}

			if(typeof(todasLasAsignaturasHTML)!='undefined')
			{
				$.each(todasLasAsignaturasHTML,function(i, tr)
				{
					if( typeof(tr)!='undefined' )
					{
						var tmpasignatura = $(tr).attr('data-tmpasignatura');
						if(!todasLasAsignaturasConNota.includes(tmpasignatura))
						{
							tr.remove();
						}
					}
				});
			}
		}

		var llenarNotasEnAsigantura = function (materias)
		{
			for (var i=0; i<materias.length;i++)
			{
				var tmp=materias[i];
				if(typeof(tmp)!='undefined')
				{
					if(tmp.hasOwnProperty('id'))
					{
						var tr = $('.regularizacion-registrar-notas-'+tmp.id);
						if(typeof(tr)!='undefined')
						{
							var input = tr.find('td input.register-notas');
							if(typeof(input)!='undefined')
							{
								if(tmp.hasOwnProperty('nota'))
								{
									var nota=parseInt(tmp.nota);
									if(!isNaN(nota))
									{
										input.val(nota);
									}
								}
							}
						}
					}
				}
			}
		}

		var cambiarEstadoRegistroNota = function (id,estado)
		{
			var tr = $('.tbody-subject-assignment').find('tr[class^=regularizacion-materias-inscritas-'+id+']');
			if(typeof(tr)!='undefined')
			{
				if(estado==1)
				{
					tr.find('.data-calificacion').html('<span class="label label-success">Registrado</span>');
				}
				else
				{
					tr.find('.data-calificacion').html('<span class="label label-warning">Sin registro</span>');
				}
			}
		}

		var abrirModalRegistrarCalificaciones=function (btn,e)
		{
			$('.inscription-id').val('');
			if(typeof(btn)!='undefined')
			{
				var tramite=$(btn).attr('data-tramite');
				var id=$(btn).attr('data-id');
				var titulo=$(btn).attr('data-txtTitulo');
				// var gestion=$(btn).attr('data-txtGestion');
				var nivel=$(btn).attr('data-txtNivel');
				var grado=$(btn).attr('data-txtGrado');
				var paralelo = $('.register-paralelo');
				var turno = $('.register-turno');
				if(typeof(tramite)!='undefined' && typeof(id)!='undefined')
				{
					//console.log('tramite: '+tramite);
					// console.log('id: '+id);
					var form=new FormData();
					form.set('tramite',tramite);
					form.set('id',id);
					var paralelos=new Array();
					var turnos=new Array();
					var materias=new Array();
					var modal=$('.form-register-grade');
					modal.find('.span-txt-nombre').html(' - '+titulo);
					// modal.find('.div-txt-gestion').html(gestion);
					modal.find('.div-txt-nivel').html(nivel);
					modal.find('.div-txt-grado').html(grado);
					if(typeof(paralelo)!='undefined')
					{
						paralelo.attr('data-tramite', tramite);
						paralelo.attr('data-id', id);
					}
					if(typeof(turno)!='undefined')
					{
						turno.attr('data-tramite', tramite);
						turno.attr('data-id', id);
					}
					//console.log(id);
					ejecutandoAccion('regularizacion-materias-inscritas-'+id,'btn-register-grade','Procesando ...');
					
					try
					{
						//verificamos si ya existe un registro de notas de la inscripcion con el ID id, de ser asi lo cargamos
						getDetalleInscripcion(form,
						function(data)//en caso de exito llamara a esta funcion
						{
							//obtenemos los datos
							
							datos=JSON.parse(data.data);
							paralelos	= (datos.paralelos);
							materias 	= (datos.materias);
							turnos		= (datos.turnos);
							//llenamos el html con los datos necesatrios
							//var p = llenarSelect(paralelos,'register-paralelo',['id','paralelo']);
							var t = llenarSelect(turnos,'register-turno',['id','turno']);
							//var m = llenarMaterias(materias,'tbody-grades-assignment',tramite,id,gestion);
							ejecutandoAccion('regularizacion-materias-inscritas-'+id,'btn-register-grade','Registrar/actualizar notas');
							if(t==1)
							{	
								// console.log('ok');
								$('.inscription-id').val(id);
								llenarDatosInscripcionSiExiste(id);
								abrirModal('modal-register-grade');
							} else {
								alert('Acaba de ocurrir un error, no se pudo obtener la lista de materias, por favor vuelva a intentarlo.');
								return;
							}
						},
						function(data)//en caso de error llamara a esta funcion
						{
							ejecutandoAccion('regularizacion-materias-inscritas-'+id,'btn-register-grade','Registrar/actualizar notas');
							alert('Acaba de ocurrir un error, no se pudo obtener la lista de materias, por favor vuelva a intentarlo.');
							return;
						});
					}
					catch(e)
					{
						ejecutandoAccion('regularizacion-materias-inscritas-'+id,'btn-register-grade','Registrar/actualizar notas');
						alert('Acaba de ocurrir un error, por favor vuelva a intentarlo.');
					}
				}
				else
				{
					alert('Acaba de ocurrir un error, por favor vuelva a intentarlo.');
				}
			}
			else
			{
				alert('Acaba de ocurrir un error, por favor vuelva a intentarlo.');
			}
		}

		var llenarSelect = function (_datos,_contendor,_campos)
		{
			var completado = 0;
			if(typeof(_datos)!='undefined')
			{
				var items='<option value="">No seleccionado</option>';
				$.each(_datos,function(i, item)
				{
					var opcion=new Object();
					for(var i in _campos)
					{
						if(item.hasOwnProperty(_campos[i]))
							opcion[_campos[i]]=item[_campos[i]];
						else
							continue;
					}
					var tmp='<option value="'+opcion[_campos[0]]+'">'+opcion[_campos[1]]+'</option>';
					items=items+tmp;
				});
				if(items.length>0)
				{
					completado = 1;
					$('.'+_contendor).html(items);
				}
				else
				{
					completado = 0;
				}
			}
			else
			{
				completado = 0;
			}
			return completado;
		}

		
		// var llenarMaterias = function (_datos,_contendor,_tramite,_idInscripcion,_gestion,_nivel,_grado)
		var llenarMaterias = function (_datos,_contendor,_idInscripcion)
		{
			var completado = 0;
			var tr='';
			var c=1;
			var maxNota=100;
			var lenText=2;
			var notaAprobacion=51;
			

			// notaAprobacion = getNotaAprobacionDeMateria(_gestion,_nivel,_grado);
			// notaAprobacion = 51;
			// maxNota = (notaAprobacion==36)?70:100;
			// maxNota = 100;
			lenText = maxNota.toString().length;
			if(notaAprobacion==-1)
			{
				alert('No existe materias para esta gestión');
				return completado;
			}
			$.each(_datos,function(i, materia)
			{
				var tmp = '<tr class="regularizacion-registrar-notas-'+materia.idAsignatura+'" data-tmpasignatura="'+materia.idAsignatura+'">\
						<th scope="row">'+c+'</th>\
						<td style="font-size:0.8rem">'+materia.asignatura+'</td>\
						<td>\
						<input type="text" class="form-control text-right only-numbers register-notas" name="register_notas['+_idInscripcion+']['+materia.idAsignatura+']" id="register_notas['+_idInscripcion+']['+materia.idAsignatura+']" data-materia="'+materia.asignatura+'" maxlength="'+lenText+'" size="'+lenText+'"  data-max="'+maxNota+'"  data-aprobacion="'+notaAprobacion+'" autocomplete="off" required>\
						</td>\
						</tr>';
						tr=tr+tmp;
						c=c+1;
			});
			if (tr.length>0)
			{
				completado=1;
				$('.'+_contendor).html(tr);
			}
			else
				completado=0;
			return completado;
		}

		// var llenarMaterias = function (_datos,_contendor,_tramite,_idInscripcion,_gestion,_nivel,_grado)
		// var llenarMateriasArray = function (_datos,_contendor,_idInscripcion)
		// {
		

		var getDetalleInscripcion = function(_form,callback,callbackError)
		{
			$.ajax({
				type:'POST',
				url:'{{ path("regularizacion_pre_bachillerato_getDetalleInscripcion") }}',
				data:_form,
				dataType: 'json',
				processData: false,
				contentType: false,
				success:callback,
				error: callbackError,
			});
		}

		var verificarInputConClase = function (_form,_inputsClass)
		{
			var inputsTMP=_form.find('.'+_inputsClass);
			var error = false;
			var msj = 'Ocurrio un error desconocido, por favor vuelva a intentarlo';
			if(inputsTMP.length>0)
			{
				for(var i=0;i< inputsTMP.length;i++)
				{
					var materia 		= inputsTMP[i];
					var nombreMateria 	= typeof($(materia).attr('data-materia'))=='undefined'?'':$(materia).attr('data-materia');
					var notaMateria 	= $(materia).val();
					var notaMax 		= typeof($(materia).attr('data-max'))=='undefined'?-1:parseInt($(materia).attr('data-max'));

					if(notaMateria=="")
					{
						if(nombreMateria.length>0)
							msj  ='La materia '+nombreMateria+' debe tener una calificación';
						else
							msj = 'Todas las materias deben tener una calificación';
						error=true;
						break;
					}
					else
					{
						notaMateria=parseInt(notaMateria);
						if(notaMateria>notaMax)
						{
							msj  ='La materia '+nombreMateria+' debe tener una calificación menor o igual a: '+notaMax;
							error=true;
							break;
						}
					}
				}
			}
			else
			{
				msj = 'Todas las materias deben tener una calificación';
				error=true;
			}
			return {'error':error,'msj':msj};
		}

		var formRegisterGrade=function (_form,e)
		{
			e.preventDefault();
			var form 			= _form.serialize();
			var _btn_submit 	= 'btn-register-grade';
			var id 				= _form.find('.inscription-id');

			if($('.register-paralelo').val()=="")
			{
				alert('El campo paralelo es requerido.');
				return;
			}
			if($('.register-turno').val()=="")
			{
				alert('El campo turno es requerido.');
				return;
			}
			var errorMaterias= verificarInputConClase(_form,'register-notas');
											
			if(errorMaterias.error)
			{
				alert(errorMaterias.msj);
				return;
			}

			deshabilitarElemento(_form,_btn_submit);
			ejecutandoAccion('form-register-grade',_btn_submit,'Procesando solicitud ...');
			if(typeof(id)!='undefined')
			{	
				var data=unserialize(form);
				setTimeout(function ()
				{
					var estado = setSerializeTmpData(data,id.val(),'form-send-request');
					// console.log(estado);
					// console.log(id.val());
					if(estado)
					{
						cambiarEstadoRegistroNota(id.val(),1);
						cerrarModal('modal-register-grade');
					}
					else
					{
						alert('Acaba de ocurrir un error, por favor vuelva a intentarlo.');
					}
					habilitarElemento(_form,_btn_submit);
					ejecutandoAccion('form-register-grade',_btn_submit,'Registar/Actualizar');
				},1000);
			}
			else
			{
				habilitarElemento(_form,_btn_submit);
				ejecutandoAccion('form-register-grade',_btn_submit,'Registar/Actualizar');
				alert('Acaba de ocurrir un error, por favor vuelva a intentarlo.');
			}
		}

		var xyz=function (_form,_campo)
		{
			var arrayMaterias=new Array();
			for(var i in _form)
			{
				var patt = new RegExp('^'+_campo);
				var test = patt.test(i);
				if(test)
				{
					var tmp=i.match(/\[(\d+)\]\[(\d+)\]/);
					var tmpObj=new Object();
					//tmpObj[tmp[2]]=_form[i];
					tmpObj['id']=tmp[2];
					tmpObj['nota']=_form[i];
					arrayMaterias.push(tmpObj);
				}
			}
			return arrayMaterias;
		}

		var serializeTmpData =function (_form,_inscripcion_id)
		{
			var datos = null;
			var tmp2 = key.match(/\[(\d+)\]\[(\d+)\]/);
			var arrayTodo = new Array();
			if(typeof(_form)!='undefined')
			{
				try
				{
					var paralelo=_form.register_paralelo;
					var turno = _form.register_turno;
					var materias = xyz(_form,'register_notas');

					var datosObj=new Object();
					datosObj['paralelo']=paralelo;
					datosObj['turno']=turno;
					datosObj['materias']=materias;

					var registro=new Object();
					registro[_inscripcion_id]=datosObj
					datos = JSON.stringify(registro);
				}
				catch(e)
				{
					datos=null;
				}
			}
			else
			{
				datos = null;
			}
			return datos;
		}

		var setSerializeTmpData=function (_data,_inscripcion_id,_contenedor)
		{
			var datos=serializeTmpData(_data,_inscripcion_id);
			var completado=false;
			var form=$('.'+_contenedor);
								
			if(typeof(form)!='undefined' && datos !=null)
			{
				var existeHidden=form.find('#request_materias_'+_inscripcion_id);
				var hidden;
				if(typeof(existeHidden)!='undefined')
				{
					existeHidden.remove();
				}
				hidden="<input type='hidden' name='request_materias["+_inscripcion_id+"]' id='request_materias_"+_inscripcion_id+"' value='"+datos+"'>";
				form.append(hidden);
				completado = true;
			}
			return completado;
		}

		var verificarRegistroDeNotas = function()
		{
			var inscripciones = $('.tbody-subject-assignment').find('tr[class^=regularizacion-materias-inscritas-]');
			var form = $('.form-send-request');
			var correcto = true;
			var cantidadInscripcion=0;
											
			if(typeof(inscripciones)!='undefined' && typeof(form)!='undefined')
			{
				for(var i=0;i<inscripciones.length;i++)
				{
					var id=$(inscripciones[i]).attr('data-id');
					var inscripcion = form.find('#request_materias_'+id);
					if(typeof(inscripcion)!=undefined)
					{
						try
						{
							var datos=$(inscripcion).val();
							var datos=JSON.parse($(inscripcion).val());
							if(datos.hasOwnProperty(id))
							{
								var tmp=datos[id];
								if(tmp.hasOwnProperty('materias'))
								{
									correcto=true;
									cantidadInscripcion+=1;
								}
								else
								{
									correcto=false
									break;
								}
							}
							else
							{
								correcto=false;
								break;
							}
						}
						catch(e)
						{
							correcto=false;
							break;
						}
					}
					else
					{
						correcto=false;
						break;
					}
				}
			}
			else
			{
				correcto = false;
			}

			if(inscripciones.length != cantidadInscripcion)
				correcto = false;

			return correcto;
		}

		var formSendRequest=function (_form,e)
		{
			e.preventDefault();
			var _btn_submit 	='btn-send-request-distrital';
			var _form_submit 	='form-send-request';
			var form 			= new FormData(_form);
			var informe 		= $('#request_fileInforme');
			var tramite 		= $('#request_tramite');
			var notas 			= verificarRegistroDeNotas();

			if(typeof(informe)=='undefined' || informe.val()=='')
			{
				alert('Debe adjuntar el informe');
				return;
			}

			if( typeof(tramite) != 'undefined' && tramite.val().length<=0)
			{
				alert('Acaba de ocurrir un error, por favor vuelva a intentarlo.');
				return;
			}
			if(!notas)
			{
				alert('Debe llenar las calificaciónes para todas las inscripciones a regularizar.');
				return;
			}
			var q=confirm('¿Está seguro de enviar la solicitud a la siguiente área?');
			if(q==false)
			{
				return;
			}
			$.ajax(
			{
				type: 'POST',
				url: '{{path("regularizacion_pre_bachillerato_postEnviarSolicitudDistrital")}}',
				data: form,
				dataType: 'json',
				contentType: false,
				cache: false,
				processData:false,
				beforeSend: function()
				{
					deshabilitarElemento(_form,_btn_submit);
					ejecutandoAccion(_form_submit,_btn_submit,'Procesando solicitud ...');
				},
				success: function(data)
				{
					var status=data.status;
					var msg= data.msj;
					var tramite = data.data;
					// var urlReporte =  data.urlReporte;
					var urlActaSupletoria =  data.urlActaSupletoria;

					if(status==200)
					{
						$('.container-fluid-').fadeOut(function ()
						{
							$('.container-fluid-').html('');
						});
						$('.container-fluid-').fadeIn(function ()
						{
							swal({
								title: msg,
								icon: "success",
							});
						
							//$('.container-fluid-').html('<div class="alert alert-success alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+msg+'</div>');
							// var reporte = '<a href="'+urlReporte+'" target="_blank" title="Descarga evaluación"><i class="fa fa-file-pdf-o fa-3x text-danger" aria-hidden="true"></i> Descarga evaluación</a>';
							var actaSupletoria = '<a href="'+urlActaSupletoria+'" target="_blank" title="Descarga Acta Supletoria"><i class="fa fa-file-pdf-o fa-3x text-danger" aria-hidden="true"></i> Descarga Acta Supletoria</a>';
							$('.container-fluid-').html('<div class="alert alert-success alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+msg+'<br>'+actaSupletoria+'</div>');
						});
						{#
							setTimeout(function ()
							{
								window.location.href="{{path('wf_tramite_index')}}";
								},2000);
						#}
					}
					else
					{
						habilitarElemento(_form,_btn_submit);
						ejecutandoAccion(_form_submit,_btn_submit,'Enviar a la Distrital');
						alert(msg);
					}
				},
				error:function (xhr)
				{
					habilitarElemento(_form,_btn_submit);
					ejecutandoAccion(_form_submit,_btn_submit,'Enviar a la Distrital');
					try
					{
						var data 	= JSON.parse(xhr.responseText);
						var msj 	= data.msj;
						var status 	= data.status;
						if(status== 404)
							alert(data.msj);
						else
							alert('Acaba de ocurrir un error por favor vuelva a intentarlo.');
					}
					catch(e)
					{
						alert('Acaba de ocurrir un error por favor vuelva a intentarlo.');
					}
				}
			});
		}
	</script>
{% endblock %}