{% extends app.session.get('layout') %}
{% block contentoption %}
    
    <style type="text/css">
        [v-cloak]{
            display: none;
        }
        .formRequired{
            margin-left: 5px;color: red;
        },
        .buscador{
            margin-top: -20px;
            /* background: #E4E4E4; */
            padding: 10px;
        }
        .encabezado{
            padding: 5px;
            /* font-weight: bold; */
        }
        .estudiante{
            padding: 10px;
            background: #EEEEEE;
            text-align: center;
            font-weight: bold;
            font-size: 17px;
        }
        .jupper{
            text-transform: uppercase;
        }
        input[type='text']{
            /* background: #000000; */
            text-transform: uppercase;
            color: #000000 !important;
        }
        .select-nota:hover{
            /* border-color: #60AA5D; */
            background: #EAFBF1;
            color: #009900;
        }
        .seleccionado{
            background: #B8F1CA !important;
        }
        .headtabla{
            background: #717171 !important;
            color: #FFFFFF;
            border-bottom: none !important;
        }
        .check{
            /* background: #EEEEEE; */
            /* margin-right: 30px; */
        }
        h5{
            font-weight: bold;
        }
        .cajaPromedio{
            font-weight: bold; 
            /* background:#DDDDDD; */
            background:#EAEAEA !important;
        }
        .cajaNota{
            cursor: pointer;
        }

        .include{
            margin: 20px;
        }
        .titulo{
            padding: 5px;
        }
        .tachado{
            text-decoration: line-through;
            /* color: #D5956E; */
            /* color:  #D51528; */
            color:  #555555;
            opacity: 0.4;
            /* display: none; */
        }
        /* nota seleccionada */
        .notaNueva{
            /* color: #1EB480; */
            /* color: #7B7DA7; */
            font-size: 1.2em;
        }
        .notaNuevaAprobado{
            /* color: #1EB480; */
            color: #5CA813;
            font-size: 1.2em;
        }
        .notaNuevaReprobado{
            /* color: #1EB480; */
            color: #E62220;
            font-size: 1.2em;
        }
        input[type=”file”]#image {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        label[for="image"] {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            background-color: #14A1DA;
            display: inline-block;
            transition: all .5s;
            cursor: pointer;
            padding: 5px 20px !important;
            width: fit-content;
            text-align: center;
        }
        .vistaModificaciones{
            float: right;
            font-size: 1.2em;
        }
        textarea{
            resize: vertical;
        }
    </style>
    <style type="text/css">
        .requisitos{
            background: #EEEEEE;
            padding: 5px;
            padding-left: 50px;
            box-shadow: 4px 4px #DDDDDD;
            margin-bottom: 15px;
        }
        .requisitos > .checkbox > label{
            color: #2A3271;
            font-size: 1.2rem !important;
        }
    </style>

    <div class="header-content">
        <h2 name="tramiteEnviado"><i class="fa fa-list-alt"></i> Trámites <span></span></h2>
        <div class="breadcrumb-wrapper hidden-xs">
            <span class="label">Usted esta aquí:</span>
            <ol class="breadcrumb">
                <li>
                    <i class="fa fa-home"></i>
                    <a href="{{ path('wf_tramite_index') }}">Tramites</a>
                    <i class="fa fa-angle-right"></i>
                </li>
                <li>
                    <i class="fa fa-file"></i>
                    Modificaciòn y/o Adiciòn de Calificaciones
                    <i class="fa fa-angle-right"></i>
                </li>
                <li class="active">Formulario</li>
            </ol>
        </div><!-- /.breadcrumb-wrapper -->
    </div><!-- /.header-content -->
    <div class="include animated fadeIn">
        {% if idTramite is not null %}
            {% include 'SieProcesosBundle:TramiteModificacionCalificaciones:historial.html.twig' with { 'historial': historial} %}
        {% endif %}
    </div>
    <div id="app">
    <div v-cloak>
        <div class="body-content animated fadeIn">

            <div class="panel panel-primary" v-if="urlreporte == ''">
                <div class="panel-heading yearOld">
                    <h3 class="panel-title"> <i class="fa fa-file"></i> Formulario de Regularización de Historial Académico con documentos </h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div class="text-center">
                                <h3>FORMULARIO DE INSCRIPCIÓN Y REGISTRO DE CALIFICACIONES</h3>
                            </div>
                            <a class="btn btn-primary yearOld" data-toggle="modal" href='#modalEstudiante' style="float:right; margin-top:-12px;" > <i class="fa fa-search"></i> Buscar estudiante </a>
                            <div class="clearfix"></div>
                            <div v-if="datos != ''">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                        <table class="table table-condensed table-bordered">
                                            <thead>
                                                <tr>
                                                    <th colspan="4">
                                                        <b>Datos del Estudiante:</b>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr><th>Código RUDE:</th><td colspan="3">${codigoRude}</td></tr>
                                                <tr><th>Nombre:</th><td colspan="3">${estudiante}</td></tr>
                                                <tr><th>Cédula de Identidad</th><td>${carnet} ${complemento}</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                        <table class="table table-condensed table-bordered">
                                            <thead>
                                                <tr><th colspan="4"><b>Datos de la Unidad Educativa (Solicitante)</b></th></tr>
                                            </thead>
                                            <tbody>
                                                <tr><th>Unidad Educativa</th><td colspan="3">${sie} - ${institucioneducativa}</td></tr>
                                                <tr>
                                                    <th>Departamento</th><td>${departamento}</td>
                                                    <th>Distrito</th><td>${distrito}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                  
                                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 ">
                                        <table class="table table-condensed table-bordered " >
                                            <thead>
                                                <tr><th colspan="4"><b>Datos del Trámite</b></th></tr>
                                            </thead>
                                            <tbody>
                                                <tr><th colspan="4" class="yearOld">Datos de la Solicitud de Inscripción</th></tr>
                                                <tr><th>Nivel</th><td>${nivel}</td><th>Paralelo</th><td>${paralelo}</td></tr>
                                                <tr><th>Grado</th><td>${grado}</td><th>Turno</th><td>${turno}</td></tr>
                                                <tr><td colspan="2"></td><th>Gestión</th><td>${gestion}</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {# VISUALIZACION Y REGISTRO DE CALIFICACIONES#}
                                <div v-if="notas.length > 10000 || notasCualitativas.length > 10000">
                                    <table v-if="notas.length > 0" class="table table-bordered table-striped table-condensed">
                                        <thead>
                                            <tr>
                                                <th colspan="5">Cuantitativas</th>
                                            </tr>
                                            <tr>
                                                <th class="headtabla">Área</th>
                                                <th class="headtabla">Periodo</th>
                                                <th class="headtabla">Calificación actual</th>
                                                <th class="headtabla">Nueva calificación</th>
                                                <th class="headtabla"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(nota, pos) in notas">
                                                <td>${nota.asignatura}</td>
                                                <td>${nota.bimestre}</td>
                                                <td align="center">${nota.nota}</td>
                                                <td align="center">
                                                    {# <input type="text" class="form-control input-sm" style="width:50px;" v-model.number="nota.notaNueva" v-on:keypress="validarNota" v-on:keyup="validarValorNota(nota)" maxlength="3"> #}
                                                    <b>${ nota.notaNueva }</b>
                                                </td>
                                                <td align="center">
                                                    <button type="button" class="btn btn-default btn-xs text-danger" v-on:click="eliminarNota(nota)"> <i class="fa fa-minus-circle" data-toggle="tooltip" data-placement="top" data-original-title="Eliminar"></i> Quitar  </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <br>
                                    <table v-if="notasCualitativas.length > 0" class="table table-bordered table-striped table-condensed">
                                        <thead>
                                            <tr>
                                                <th colspan="4">Cualitativas</th>
                                            </tr>
                                            <tr>
                                                <th class="headtabla">Periodo</th>
                                                <th class="headtabla">Valoración actual</th>
                                                <th class="headtabla">Nueva valoración</th>
                                                <th class="headtabla"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(cualitativa, pos) in notasCualitativas">
                                                <td class="table-cell" style="vertical-align:middle">${cualitativa.bimestre}</td>
                                                <td>${cualitativa.notaCualitativa}</td>
                                                <td>
                                                    ${cualitativa.notaNuevaCualitativa}
                                                    {# <textarea class="form-control input-sm jupper jnumbersletters" cols="17" rows="4" v-model="cualitativa.notaNuevaCualitativa" v-on:keypress="validarNotaCualitativa();" v-on:keyup="validarValorNotaCualitativa(cualitativa)"></textarea> #}
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-default btn-xs text-danger" v-on:click="eliminarNotaCualitativa(cualitativa)"> <i class="fa fa-minus-circle"></i> Quitar </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <hr>
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                            <h5><b>Justificativo</b></h5>
                                            <textarea v-model="justificacion" id="" rows="2" class="form-control jupper" ref="justificacion"></textarea>
                                        </div>
                                        {# <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                            <h5>Adjuntar Informe técnico</h5>
                                            <input type="file" name="image" @change="getImage" accept="file/*" class="form-control">
                                        </div> #}
                                    </div>

                                

                                </div>
                                <div v-else>
                                   <table class="table table-bordered" id="tablaNotas" style="background:#FFFFFF">
                                        <thead>
                                            <tr>
                                                <th>Área</th>
                                                <th>Nota final</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                    
                                        <tr v-for="(currentmateria, index) in materiasnotas" :key="index">
                                                <td><span> ${currentmateria.asignatura} </span></td>
                                                <td> 
                                                    <input type="number" class="form-control number-only" maxlength="3" min="51" max="100" id="notas[index]"  v-model="currentmateria.nota"  >
                                                </td>
                                        </tr>
                                            
                                        </tbody>
                                    </table>
                                        <div class="row">
                                        <hr>
                                        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                            <h5><b>Requisitos mínimos que debe presentar a la Dirección Departamental</b></h5>
                                            <div class="requisitos">
                                                <div class="checkbox">
                                                    <label style="margin-left:-20px;">
                                                        <input type="checkbox" v-model="checkInforme" disabled style="display:none">
                                                        <i v-if="informe == ''" class="fa fa-square-o" style="color:#AAAAAA"></i>
                                                        <i v-else class="fa fa-check-square-o"></i>
                                                        &nbsp;Informe técnico
                                                        <input type="file" id="image" name="image" @change="getImage" accept="file/*" style="display:none">
                                                        <label for="image"> <i class="fa fa-upload"></i> 
                                                            <span v-if="informe != ''">${informe.name}</span>
                                                            <span v-else>Adjuntar informe</span>
                                                        </label>
                                                    </label>
                                                </div>
                                                
                                            </div>
                                            <div class="text-center">
                                                <a href="" class="btn btn-default">Cancelar</a>
                                                <button v-bind:disabled="formularioEnviado" v-on:click="enviarSolicitud()" type="button" class="btn btn-success">Enviar solicitud ABD</button>
                                            </div>
                                        </div>
                                    </div>
                                   
                                </div>
                                                         
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <div v-else>
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title"> <i class="fa fa-file-pdf-o"></i> Trámite enviado</h3>
                    </div>
                    <div class="panel-body">
                        <div class="alert alert-success">
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                            Trámite de Regularización de Historial Académico Nro. <b class="text-success">${respuestaIdTramite}</b> enviado exitosamente para revisión de la Dirección Departamental.
                             <div class="text-center">
                            <a v-bind:href="urlreporte"><b> <i class="fa fa-file-pdf-o fa-2x"></i> Descargar formulario</b></a>
                        </div>
                        </div>
                       
                    </div>
                </div>
            </div>

        </div>
        {#D ATOS INICIALES DE INSCRIPCION Y ESTUDIANTE #}
        <div class="modal fade" id="modalEstudiante">
            <div class="modal-dialog" style="width:800px">
                <div class="modal-content">
                    <div class="modal-header yearOld">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title"> <i class="fa fa-search"></i> Buscar estudiante</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group row buscador">
                            <div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 text-right">
                                Código Rude
                            </div>
                            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                <input type="text" class="form-control" v-model="rudeBuscar" maxlength="18" v-on:keyup.enter="buscarEstudiante()" placeholder="Ingrese el Código RUDE a buscar">
                            </div>
                            <div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
                                <button v-on:click="buscarEstudiante()" type="button" class="btn btn-primary yearOld"><i class="fa fa-search"></i> Buscar </button>
                            </div>
                        </div>

                        <div class="alert alert-warning" v-if="respuesta != ''"> <i class="fa fa-warning"></i> ${respuesta}</div>
                        <div v-if="buscando" class="text-center">
                            <img src="{{asset('img/loading.gif')}}" alt=""> Buscando...
                        </div>

                        <div v-if="inscripciones.length > 0">
                            <p class="encabezado yearOld">Datos Estudiante</p>
                            <table class="table table-primary">
                                <tr>
                                    <th>Código Rude</th>
                                    <td>${codigoRude}</td>
                                </tr>
                                <tr>
                                    <th>Estudiante</th>
                                    <td>${estudiante}</td>
                                </tr>
                                <tr>
                                    <th>Cédula de Identidad</th><td>${carnet} ${complemento}</td>
                                  </tr>
                            </table>
                            <br>
                            {# <p class="encabezado bg-primary">Informacion Solicitud <span> ()</span> </p> #}
                            <div v-if="cargandoCalificaciones" style="position:absolute; text-align:center; background:#FFFFFF; width:96%">
                                <img src="{{asset('img/loading.gif')}}" alt=""> Cargando calificaciones de la gestion ${gestion}
                            </div>
                            <div class="row">  
                                <div class="col-md-12">

                                    <div class="panel panel-primary" v-if="urlreporte == ''">
                                        <div class="panel-heading yearOld">
                                            <h3 class="panel-title"> <i class="fa fa-file"></i> Solicitud de Inscripción </h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="table-responsive">
                                       
                                                <div class="row">
                                                    <div class="col-sm-5">
                                                        <label for="localidad"><B>CÓDIGO UE</B></label>
                                                        <input type="input" class="form-control" id="idUe" placeholder="SIE" v-model="DBinfoInscription.sieActual" maxlength="8" >
                                                    </div>
                                                    <div class="col-sm-5">
                                                        <label for="sie22">Gestion<span class="formRequired">*</span></label>
                                                        <select name="arrYear" id="idYear" v-model="DBinfoInscription.gestionSelected" class="custom-select form-control" v-on:change="loadLevel">
                                                            <option value="">Seleccionar...</option>
                                                            <option v-for="item in DBYears"  :value="item.id">${ item.year }</option>
                                                        </select>	                                  
                                                    </div>                                  
                                                   
                                                </div>
                                                <div class="row" v-if="mensajeExiste != ''">
                                                    <div class="col-md-12">
                                                        <p class="p-12 mb-8 bg-danger"> <strong>${mensajeExiste}</strong></p>
                                                    </div>
                                                </div>
                                                <div class="row" v-if="nombreUe != ''">
                                                    <div class="col-md-12">
                                                        <p class="p-6 mb-5 bg-success"> <strong>${nombreUe} ${departamento} ${distrito}</strong> </p>
                                                    </div>
                                                </div>
                                                <div class="row"  v-if="cargandoNiveles">
                                                        <div class="col-sm-3">
                                                            <label for="nivel">Nivel<span class="formRequired">*</span></label>                                  
                                                            <select name="arrLevel" id="idpais" v-model="DBinfoInscription.nivelId" class="custom-select form-control" v-on:change="loadGrado">
                                                            <option value="">Seleccionar...</option>
                                                            <option v-for="item in DBLevel"  :value="item.id">${ item.level }</option>#}
                                                            </select>
                                                        </div>
                                                        <div class="col-sm-2">
                                                            <label for="depto">Grado<span class="formRequired">*</span></label>
                                                            <select name="arrGrado" id="idgrado" v-model="DBinfoInscription.gradoId" class="custom-select form-control" v-on:change="loadParalelo">  
                                                                <option value="">Seleccionar...</option>
                                                                <option v-for="item in DBGrado"  :value="item.id">${ item.grado }</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-sm-2">
                                                            <label for="paralelo">Paralelo<span class="formRequired">*</span></label>
                                                            <select name="arrParalelo" id="idparalelo" v-model="DBinfoInscription.paraleloId" class="custom-select form-control"  v-on:change="loadTurno">  
                                                                <option value="">Seleccionar...</option>
                                                                <option v-for="item in DBParalelo"  :value="item.id">${ item.paralelo }</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-sm-3">
                                                            <label for="turno">Turno<span class="formRequired">*</span></label>
                                                            <select name="arrTurno" id="idturno" v-model="DBinfoInscription.turnoId" class="custom-select form-control" v-on:change="loadButton1" >  
                                                                <option value="">Seleccionar...</option>
                                                                <option v-for="item in DBTurno"  :value="item.id">${ item.turno }</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                    <div class="col-sm-12">
                                                        </br>
                                                        <a  v-if="!this.RequestInscription.length && cargandoButton1" class="btn btn-warning yearOld" style="float:right; margin-top:-2px;" @click='registreInscription' > <i class="fa fa-book"></i> Registrar </a>
                                                    </div>                     
                                                    </div>
                                                </div>                                            
 
                                            </div>                                                  
                                        </div>
                                    </div>

                                    {# start here the inscription request #}
                                    <div class="panel panel-primary" v-if="this.RequestInscription.length > 0">
                                        <div class="panel-heading yearOld">
                                            <h3 class="panel-title"> <i class="fa fa-file"></i> Datos de Inscripción </h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-default" >
                                                    <thead>
                                                        <tr>
                                                            <th class="text-center border-right">#</th>
                                                            <th>Gestión</th>
                                                            {# <th>Sie</th>
                                                            <th>Institución educativa</th> #}
                                                            <th>Nivel</th>
                                                            <th>Grado</th>
                                                            <th>Paralelo</th>
                                                            <th>Turno</th>
                                                            <th></th>
                                                            <th></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr v-for="(requesetIns, index) in RequestInscription">
                                                            <td class="text-center border-right">${ index + 1}</td>
                                                            <td>${requesetIns.gestion}</td>
                                                            <td>${requesetIns.nivel}</td>
                                                            <td>${requesetIns.grado}</td>
                                                            <td>${requesetIns.paralelo}</td>
                                                            <td>${requesetIns.turno}</td>
                                                            <td><a class="btn btn btn-xs" data-toggle="tooltip" data-placement="top" data-original-title="Eliminar"  @click='removeRequest(index)'> <i class="fa fa-trash text-danger"></i> </a></td>
                                                            <td>
                                                            <a v-on:click="seleccionarInscripcion(index)" class="btn btn btn-xs" data-toggle="tooltip" data-placement="top" data-original-title="Registrar Notas"> <i class=" fa fa-pencil text-success"  ></i> Continuar</a></td>
                                                            {#v-bind:href="'{{path("solicitud_modificacion_calificaciones_formulario_index")}}?idInscripcion=' + ins.idInscripcion"#}
                                                            
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>                                                    
                                        </div>
                                    </div>    
                                    {# end here the inscription request #}
                                
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>


      

        <div class="modal fade" id="11modalCalificacionesAntes">
            <div class="modal-dialog" style="width:800px">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Calificaciones</h4>
                    </div>
                    <div class="modal-body">
                        <h4 class="yearOld titulo ">--- <small style="float:right;color:white"> (Haga clic sobre la calificación que quiere adicionar y/o modificar)</small>
                            {# <div class="vistaModificaciones">
                                <i v-if="verModificaciones" class="fa fa-eye" v-on:click="verModificaciones = false"></i>
                                <i v-else class="fa fa-eye-slash" v-on:click="verModificaciones = true"></i>
                            </div> #}
                        </h4>
                        <table class="table table-bordered" id="tablaNotas" style="background:#FFFFFF">
                            <thead>
                                <tr>
                                    <th><small>Área</small></th>
                                    <th v-for="n in datos.titulosNotas" align="center"><small>${n.titulo}</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="a in datos.cuantitativas">
                                    <td data-title="Área">
                                        <small>${a.asignatura}</small>
                                    </td>
                                    
                                   
                                </tr>
                               
                            </tbody>
                        </table>
                        <div v-if="datos.gestion < 2019 || (datos.gestion >= 2019 && datos.nivel == 11)">
                            <h4 class="yearOld titulo ">Cualitativas <small style="float:right; color:white;"> (Haga clic sobre la valoración que quiere adicionar y/o modificar)</small></h4>
                            <table v-if="datos.cualitativas != ''" class="table table-bordered table-hover cf" id="tablaNotasCualitativas">
                                <thead>
                                    <tr class="cf">
                                        <th>Periodo</th>
                                        <th>Valoración</th>
                                    </tr>
                                </thead>
                                <tbody>
                                   
                                </tbody>
                            </table>
                            <div v-else>
                                No tiene valoraciones cualitativas...
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="pull-left">
                            Estado matricula:
                            <b>
                            <span v-bind:class="{tachado: actualEstadomatricula != nuevoEstadomatricula }">${this.actualEstadomatricula}</span>
                            <span v-if="actualEstadomatricula != nuevoEstadomatricula" >${this.nuevoEstadomatricula}</span>
                            </b>
                        </div>
                        <div class="pull-right">
                            <button type="button" class="btn btn-primary yearOld" v-on:click="cerrarModal">Aceptar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

     </div>
    </div>

{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.15.2/axios.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <script>
        var app = new Vue({
            delimiters: ['${', '}'],
            el: '#app',
            data: {
                idTramite: '{{idTramite}}',
                sieActual: '{{sieActual}}',
                buscando: false,
                rudeBuscar: '',
                respuesta: '',
                cargandoButton1: false,
                cargandoCalificaciones: false,
                cargandoNiveles: false,
                verModificaciones: true,
                nombreUe:'',
                mensajeExiste:'',

                gestionSelected:'',
                DBinfoInscription:{
                    'sieActual':'',
                    'gestionSelected':'',
                    'nivelId':'',
                    'gradoId':'',
                    'paraleloId':'',
                    'turnoId':'',
                    'rude':''
                },
                RequestInscription:[],
                RequestInscriptionSelected:[],
                DBYears: [],
                DBLevel:[],
                DBGrado:[],
                DBParalelo:[],
                DBTurno:[],
                DBCatalogLibreta:[],
                DBAsignatura:[],
                arrInfoSelected:[],
                DBCatalogoAsignatura:[],
                DBCatalogoAsignatura2:[],                               

                
                estudianteId: '',
                codigoRude: '',
                estudiante: '',
                carnet: '',
                complemento:'',

                directorNombre: '',
                directorCarnet: '',
                directorComplemento: '',

                sie: '',
                institucioneducativa: '',
                nivel: '',
                grado: '',
                paralelo: '',
                turno: '',
                gestion: '',
                departamento: '',
                distrito: '',
                
                inscripciones: [],
                datos: [],

                idInscripcion: '',
                flujoTipo: '',
                notas: [],
                asignaturasnotas: [],
                notasValidas:true,
                filas: [],
                notasCualitativas: [],
                filasCualitativas: [],
                justificacion: '',
                informe: '',
                flujoTipo: '{{flujoTipo}}',
                formularioEnviado: false,
                urlreporte: '',
                respuestaIdTramite: '',
                
                actualEstadomatricula: '',
                nuevoEstadomatricula: '',
                estadosMatricula: [],
                promedioGeneral: '',
                nuevoPromedioGeneral: '',

                checkInforme: false,
                checkCuaderno: true,
                checkFormulario: false
            },
            methods: {
                cerrarModal: function(){
                    $('#modalCalificaciones').modal('hide');
                },
                inArray: function(needle, haystack) {
                    var length = haystack.length;
                    for(var i = 0; i < length; i++) {
                        if(haystack[i] == needle) return true;
                    }
                    return false;
                },
                claseNotaTipo: function(tiponota, gestion){
                    console.log(gestion);
                    if(this.inArray(tiponota, [5,6,7,8,9,11]  ) ){
                        if(gestion == 2020)
                            return ['select-nota','cajaNota'];
                        else
                            return ['cajaPromedio'];
                    }else{
                        return ['select-nota','cajaNota'];
                    }
                },
                

                buscarEstudiante: function(){
                    this.buscando = true;
                    this.codigoRude = '';
                    this.estudiante = '';
                    this.carnet = '';
                    this.complemento = '';
                    this.inscripciones = '';
                    this.respuesta = '';
                    this.datos = '';

                    this.idInscripcion = '';
                    this.sie = '';
                    this.institucioneducativa = '';
                    this.nivel = '';
                    this.grado = '';
                    this.paralelo = '';
                    this.turno = '';
                    this.gestion = '';
                    this.departamento = '';
                    this.distrito = '';

                    this.notas = [];
                    this.filas = [];
                    this.notasCualitativas = [];
                    this.filasCualitativas = [];
                    this.justificacion = '';
                    this.informe = '';

                    if (this.rudeBuscar.length == 0) {
                        this.respuesta = 'Debe ingresar un código RUDE válido';
                        this.buscando = false;
                        return;
                    }

                    if (this.rudeBuscar.length < 13) {
                        this.respuesta = 'El código RUDE ingresado no es válido';
                        this.buscando = false;
                        return;
                    }

                    axios.get(Routing.generate('tramite_regularizacion_historial_buscar_estudiante', {
                        codigoRude: this.rudeBuscar,
                        flujoTipo: '{{ flujoTipo }}'
                    }))
                    .then(response => { 
                        if (response.status == 200) {
                            this.codigoRude = response.data.codigoRude;
                            this.estudianteId = response.data.estudianteId;
                            this.estudiante = response.data.estudiante;
                            this.carnet = response.data.carnet;
                            this.complemento = response.data.complemento;
                            this.inscripciones = response.data.inscripciones;

                            $('[data-toggle="tooltip"]').tooltip();
                        }
                        if( response.status == 202){
                            this.respuesta = response.data;
                        }

                        this.buscando = false;
                    })
                    .catch(e => {
                        console.log(e);
                        this.buscando = false;
                    });
                    this.loadData();
                },
                loadData: function(){
                    var arrYear = [];
                    var len = 2020;
                    for(var i = 2009; i<2022; i++){
                        arrYear.push({
                            id: i,
                            year: i
                        });
                    }
                    this.DBYears = arrYear;
                },
                loadLevel: function(){
                    this.DBLevel = [];
                    this.DBinfoInscription.nivelId = '';
                    this.DBGrado = [];
                    this.DBinfoInscription.gradoId = '';
                    this.DBParalelo = [];
                    this.DBinfoInscription.paraleloId = '';
                    this.DBTruno = [];
                    this.DBinfoInscription.turnoId = '';
                    this.DBinfoInscription.rude = this.codigoRude;
                    this.DBinfoInscription.estudianteId = this.estudianteId;
                    console.log(this.DBinfoInscription);
                   // this.DBinfoInscription.sieActual = this.codigoRue;
                    axios.post(Routing.generate('tramite_regularizacion_historial_loadLevel', this.DBinfoInscription))
                    .then(response => {
                        
                        if(response.status == 200){                         
                            this.mensajeExiste = '';
                            this.cargandoNiveles = true;
                            this.DBLevel = response.data.arrLevel;
                            this.nombreUe = response.data.nombreUe;
                            this.departamento = response.data.departamento;
                            this.distrito = response.data.distrito;

                        }
                        if(response.status == 202){                         
                            this.mensajeExiste = response.data.mensaje;
                        }
                    })
                    .catch(e => {
                        console.log(e);
                    });
                    
                },
                loadGrado: function(){
                    this.DBGrado = [];
                    this.DBinfoInscription.gradoId = '';
                    this.DBParalelo = [];
                    this.DBinfoInscription.paraleloId = '';
                    this.DBTruno = [];
                    this.DBinfoInscription.turnoId = '';

                    
                    axios.post(Routing.generate('tramite_regularizacion_historial_loadGrado', this.DBinfoInscription))
                    .then(response => {
                        if(response.status == 200){
                            this.DBGrado = response.data.arrGrado;
                        }

                    })
                    .catch(e => {
                        console.log(e);
                    });
                    
                },
                loadParalelo: function(){
                    this.DBParalelo = [];
                    this.DBinfoInscription.paraleloId = '';
                    this.DBTruno = [];
                    this.DBinfoInscription.turnoId = '';
                    
                    axios.post(Routing.generate('tramite_regularizacion_historial_loadParalelo', this.DBinfoInscription))
                    .then(response => {
                        if(response.status == 200){
                            this.DBParalelo = response.data.arrParalelo;
                        }
                    })
                    .catch(e => {
                        console.log(e);
                    });
                    
                },
                loadTurno: function(){
                    this.DBTruno = [];
                    this.DBinfoInscription.turnoId = '';
                    
                    axios.post(Routing.generate('tramite_regularizacion_historial_loadTurno', this.DBinfoInscription))
                    .then(response => {
                        if(response.status == 200){
                            this.DBTurno = response.data.arrTurno;
                        }
                    })
                    .catch(e => {
                        console.log(e);
                    });
                    
                }, 
                loadButton1: function(){
                    this.cargandoButton1 = true;
                    
                }, 
                registreInscription: function(){
                    $('[data-toggle="popover"]').popover();
                    $('[data-toggle="tooltip"]').tooltip();  
                          
                    // to validate the year requeset
                    if (this.DBinfoInscription['gestionSelected'].length == 0 || 
                        this.DBinfoInscription['nivelId'] == 0 || 
                        this.DBinfoInscription['gradoId'] == 0 || 
                        this.DBinfoInscription['paraleloId'] == 0 || 
                        this.DBinfoInscription['turnoId']  == -1 ||
                        this.DBinfoInscription['sieActual']  == '' 
                        ) {
                        //this.$refs.justificacion.focus();
                        Swal.fire(
                          'Error!',
                          'Debe registrar todo los campos requeridos para la solicitud.',
                          'warning'
                        );
                        return;
                    }
                    
                    var me = this;
                    let selectedkeyTurnoId;
                     $.each(this.DBTurno, function(index, val) {
                         
                         //console.log(this.DBinfoInscription['turnoId']);
                                if (val['id'] == me.DBinfoInscription['turnoId']) {
                                   selectedkeyTurnoId =index ;
                                }
                            });
              
                    let newInscription = {
                                        'sie':this.DBinfoInscription['sieActual'],
                                        'gestion':this.DBinfoInscription['gestionSelected'],
                                        'nivelId':this.DBLevel[this.DBinfoInscription['nivelId']].id,
                                        'nivel':this.DBLevel[this.DBinfoInscription['nivelId']].level,
                                        'gradoId':this.DBGrado[this.DBinfoInscription['gradoId']].id,
                                        'grado':this.DBGrado[this.DBinfoInscription['gradoId']].grado,
                                        'paraleloId':this.DBParalelo[this.DBinfoInscription['paraleloId']].id,
                                        'paralelo':this.DBParalelo[this.DBinfoInscription['paraleloId']].paralelo,
                                        'turnoId':this.DBTurno[selectedkeyTurnoId].id,
                                        'turno':this.DBTurno[selectedkeyTurnoId].turno,
                                        'keyId':'',
                                        'notasRequest':'',
                                        };
                    this.DBinfoInscription['gestionSelected'] = '';
                    this.DBinfoInscription['sieActual'] = '';
                    this.DBLevel[this.DBinfoInscription['nivelId']].id= '';
                    this.DBLevel[this.DBinfoInscription['nivelId']].level= '';
                    this.DBGrado[this.DBinfoInscription['gradoId']].id= '';
                    this.DBGrado[this.DBinfoInscription['gradoId']].grado= '';
                    this.DBParalelo[this.DBinfoInscription['paraleloId']].id= '';
                    this.DBParalelo[this.DBinfoInscription['paraleloId']].paralelo= '';
                    this.DBTurno[selectedkeyTurnoId].id= '';
                    this.DBTurno[selectedkeyTurnoId].turno= '';                                                           
                    
                    //console.log(newInscription);
                    this.RequestInscription.push(newInscription);
                    newInscription= '';
                    //console.log(this.RequestInscription);

                    //console.log(this.DBinfoInscription);
                    //$('#modalInscription').modal('hide');
                    
                    
                    return;

                },
                removeRequest: function(ikey){
                    console.log(ikey);
                    if(ikey == 0)
                        this.RequestInscription.shift();
                    else
                        this.RequestInscription.splice(ikey,ikey);                        
                    console.log(ikey);
                    console.log(this.RequestInscription);

                },                                                  
                seleccionarInscripcion: function(pos){
                
                    this.RequestInscription[pos].idTramite = this.idTramite;
                    this.RequestInscription[pos].flujoTipo = this.flujoTipo;
                    //this.RequestInscription[pos].sie =  this.RequestInscription[pos].sie;

                    this.cargandoCalificaciones = true;

                    this.idInscripcion = this.inscripciones[pos].idInscripcion;
                    this.sie =  this.RequestInscription[pos].sie
                    this.institucioneducativa = this.nombreUe;
                    this.nivel = this.RequestInscription[pos].nivel;
                    this.grado = this.RequestInscription[pos].grado;
                    this.paralelo = this.RequestInscription[pos].paralelo;
                    this.turno = this.RequestInscription[pos].turno;
                    this.gestion = this.RequestInscription[pos].gestion;

                    this.RequestInscription[pos].posSelected = pos; 
                    this.RequestInscription[pos].codigoRude = this.codigoRude; 

                    this.datos = [];
                    this.materiasnotas = [];

                    this.notas = [];
                    this.filas = [];
                    this.notasCualitativas = [];
                    this.filasCualitativas = [];
                    this.justificacion = '';
                    this.informe = '';

                    this.estadomatricula = '';
                    this.operativo = '';
                    this.idNivel = '';

                    this.nuevoEstadomatricula = '';

                    this.promedioGeneral = '';
                    this.nuevoPromedioGeneral = '';

                    // CARGAMOS LAS CALIFICACIONES
                    axios.post(Routing.generate('tramite_regularizacion_historial_buscar_calificaciones', this.RequestInscription[pos] ))
                    .then(response => {
                        if (response.data.tramitePendiente.length > 0) {
                            // console.log(response.data.tramitePendiente[0]);
                            var msg = 'La inscripción tiene un trámite pendiente. <br> <b>Trámite Nro. '+ response.data.tramitePendiente[0].tramite_id +'</b>';
                            Swal.fire({
                              title: 'Tramites pendientes!',
                              html: msg,
                              type: 'warning'
                            });
                        }else{
                            
                            this.datos = response.data.datos;
                            this.materiasnotas = response.data.materiasnotas;
                            this.estadosMatricula = response.data.estadosMatricula;
                            
                            this.promedioGeneral = response.data.promedioGeneral;
                            this.nuevoPromedioGeneral = response.data.promedioGeneral;

                            this.RequestInscriptionSelected[pos] = this.RequestInscription[pos]
                            
                            var me = this;
                            $.each(this.estadosMatricula, function(index, val) {
                                if (val['id'] == me.datos.estadoMatricula) {
                                    me.actualEstadomatricula = val['estadoMatricula'];
                                    me.nuevoEstadomatricula = val['estadoMatricula'];
                                }
                            });

                            $('#modalEstudiante').modal('hide');
                        }
                        this.cargandoCalificaciones = false;
                    })
                    .catch(e => {
                        Swal.fire(
                          'Error!',
                          e,
                          'danger'
                        );

                        this.cargandoCalificaciones = false;
                    });
                },

                eliminarNota: function(row){
                    // this.notas.splice(pos,1);
                    var index = this.notas.indexOf(row);

                    // cargamos la nota al valor de nueva nota
                    var me = this;
                    $.each(this.datos.cuantitativas, function(index, val) {
                        if (val['asignatura'] == row.asignatura) {
                            $.each(val['notas'], function(index2, val2) {
                                if (val2['idFila'] == row.idFila) {
                                    me.datos.cuantitativas[index].notas[index2].notaNueva = '';
                                }
                            });
                        }
                    });

                    this.notas.splice(index, 1);
                    var index1 = this.filas.indexOf(row.idFila);
                    this.filas.splice(index1,1);

                    $('#'+row.idFila).removeClass('seleccionado');

                    this.calcularPromedios();
                },
                validarNota: function(event){
                    var k = event.charCode || event.keyCode;
                    if ((k < 48 || k > 57) //NUmeros
                        && (k != 13) //ENTER
                        && (k != 8) //retroceso
                        && (k != 9) //tab
                    ){
                        event.preventDefault();
                        return false;
                    }
                },
                validarValorNota: function(nota){console.log(nota);
                    // VALIDACIONES TRIMESTRALES
                    if(nota.idNotaTipo == 6 || nota.idNotaTipo == 7 || nota.idNotaTipo == 8){
                        if(nota.gestion == 2020){
                            //console.log('notaaaaaa11'+nota.notaNueva);
                            if(nota.notaNueva < 0){ nota.notaNueva = 0; }
                            if(nota.notaNueva > 100){ nota.notaNueva = 100; }                            
                            //console.log('notaaaaaa22'+nota.notaNueva);
                        }else{
                            if(nota.notaNueva < 0){ nota.notaNueva = 0; }
                            if(nota.notaNueva > 70){ nota.notaNueva = 70; }
                        }
                        
                    }
                    if(nota.idNotaTipo == 30 || nota.idNotaTipo == 31 || nota.idNotaTipo == 32 || nota.idNotaTipo == 10){
                        if(nota.notaNueva < 0){ nota.notaNueva = 0; }
                        if(nota.notaNueva > 60){ nota.notaNueva = 60; }    
                    }
                    if(nota.idNotaTipo == 27 || nota.idNotaTipo == 28 || nota.idNotaTipo == 29){
                        if(nota.notaNueva < 0){ nota.notaNueva = 0; }
                        if(nota.notaNueva > 10){ nota.notaNueva = 10; }
                    }

                    // VALIDACION PARA NOTAS BIMESTRALES
                    if(nota.idNotaTipo == 1 || nota.idNotaTipo == 2 || nota.idNotaTipo == 3 || nota.idNotaTipo == 4 || nota.idNotaTipo == 5){
                        if(nota.notaNueva < 0){ nota.notaNueva = 0; }
                        if(nota.notaNueva > 100){ nota.notaNueva = 100; }    
                    }                    

                    if(nota.notaNueva != "" && nota.notaNueva != 0){
                        nota.notaNueva = Math.round(nota.notaNueva);
                    }
                    //console.log('notaaaaaa '+nota.notaNueva);
                    // cargamos la nota al valor de nueva nota
                    var me = this;

                    $.each(this.datos.cuantitativas, function(index, val) {
                        if (val['asignatura'] == nota.asignatura) {
                            console.log(val['asignatura']);
                            console.log(nota.asignatura);
                            $.each(val['notas'], function(index2, val2) {
                                if (val2['idFila'] == nota.idFila) {
                                    me.datos.cuantitativas[index].notas[index2].notaNueva = nota.notaNueva;
                                }
                            });
                        }
                    });    
                    //console.log(this.datos.cuantitativas)       ;
                    this.calcularPromedios();
                },
                calcularPromedios: function(){
                    var me = this;
                    var nulos;
                    var suma;
                    var promedio;
                    var cantidadPromedios = 0;
                    var arrayPromedios = [];
                    //to year 2020 and avg trim
                    if(this.gestion == 2020){
                        $.each(this.datos.cuantitativas, function(index, val) {
                            nulos = 0;
                            suma = 0;
                            promedio = 0;
                            $.each(val['notas'], function(index2, val2) {
                                if (val2['idNotaTipo'] != 9) {
                                    var valor = val2['notaNueva'];
                                    if(valor == ''){
                                        valor = val2['nota'];
                                        if (valor == '') {
                                            valor = 0;
                                            nulos = nulos + 1;
                                        }
                                    }
                                    suma = suma + valor;
                                }
                                if (val2['idNotaTipo'] == 9 && nulos == 0) {
                                    // CALCULAMOS EL PROMEDIO Y LO AGREGAMOS AL OBJETO
                                    promedio = Math.round(suma/3);
                                    me.datos.cuantitativas[index].notas[index2].notaNueva = promedio;
                                    // AGREGAMOS EL PROMEDIO AL ARRAY
                                    arrayPromedios.push({
                                        idAsignatura: val['idAsignatura'],
                                        promedio: promedio
                                    });
                                    // INCREMENTAMOS LA CANTIDAD DE PROMEDIOS
                                    cantidadPromedios+=1;
                                                                         
                                }
                                if (val2['idNotaTipo'] == 9 && nulos > 0) {
                                    me.datos.cuantitativas[index].notas[index2].notaNueva = '';
                                }
                            });
                        });

                        // CALCULAMOS EL ESTADO DE MATRÍCULA
                        var cantidadMaterias = this.datos.cuantitativas.length;
                        if(cantidadMaterias == cantidadPromedios){
                            var me = this;
                            $.each(this.estadosMatricula, function(index, val) {
                                if (val['id'] == 5) {
                                    me.nuevoEstadomatricula = val['estadoMatricula'];
                                }
                            });
                            // CALCULAMOS EL ESTADO GENERAL DE ACUERDO AL PROMEDIO GENERAL ANUAL EN PRIMARIA en la gestion 2019
                            if (this.datos.gestion >= 2019 && this.datos.nivel == 12) {
                                var sumaPromedios = 0;
                                var promedioGeneralAnual;
                                $.each(arrayPromedios, function(index, val) {
                                    sumaPromedios = sumaPromedios + val.promedio;
                                });
                                promedioGeneralAnual = Math.round(sumaPromedios/cantidadMaterias);

                                if (promedioGeneralAnual < 51) {
                                    $.each(me.estadosMatricula, function(index, val) {
                                        if (val['id'] == 28) {
                                            me.nuevoEstadomatricula = val['estadoMatricula'];
                                        }
                                    });
                                }

                                this.nuevoPromedioGeneral = promedioGeneralAnual;

                            }else{
                                $.each(arrayPromedios, function(index, val) {
                                    // NO CONSIDERAMOS LAS MATERIAS (ESPECIFICACMENTE PARA LA GESTION 2018)
                                    // 1052 CIENCIAS NATURALES: FISICA
                                    // 1053 CIENCIAS NATURALES: QUIMICA
                                    if(val.promedio < 51 && val.idAsignatura != 1052 && val.idAsignatura != 1053){
                                        $.each(me.estadosMatricula, function(index, val) {
                                            if (val['id'] == 11) {
                                                me.nuevoEstadomatricula = val['estadoMatricula'];
                                            }
                                        });
                                    }
                                });
                            }
                        }else{
                            var me = this;
                            $.each(this.estadosMatricula, function(index, val) {
                                if (val['estadoMatricula'] == me.actualEstadomatricula) {
                                    me.nuevoEstadomatricula = val['estadoMatricula'];
                                }
                            });
                        }                        

                    }else{
                        // CÁLCULO DE PROMEDIOS Y ESTADO DE MATRICULA PARA NOTAS BIMESTRALES
                        if ((this.gestion >= 2014 && this.datos.operativo >= 4) || (this.gestion == 2013 && this.datos.grado == 1) ) {
                            $.each(this.datos.cuantitativas, function(index, val) {
                                nulos = 0;
                                suma = 0;
                                promedio = 0;
                                $.each(val['notas'], function(index2, val2) {
                                    if (val2['idNotaTipo'] != 5) {
                                        var valor = val2['notaNueva'];
                                        if(valor == ''){
                                            valor = val2['nota'];
                                            if (valor == '') {
                                                valor = 0;
                                                nulos = nulos + 1;
                                            }
                                        }
                                        suma = suma + valor;
                                    }
                                    if (val2['idNotaTipo'] == 5 && nulos == 0) {
                                        // CALCULAMOS EL PROMEDIO Y LO AGREGAMOS AL OBJETO
                                        promedio = Math.round(suma/4);
                                        me.datos.cuantitativas[index].notas[index2].notaNueva = promedio;
                                        // AGREGAMOS EL PROMEDIO AL ARRAY
                                        arrayPromedios.push({
                                            idAsignatura: val['idAsignatura'],
                                            promedio: promedio
                                        });
                                        // INCREMENTAMOS LA CANTIDAD DE PROMEDIOS
                                        cantidadPromedios+=1;
                                    }
                                    if (val2['idNotaTipo'] == 5 && nulos > 0) {
                                        me.datos.cuantitativas[index].notas[index2].notaNueva = '';
                                    }
                                });
                            });

                            // CALCULAMOS EL ESTADO DE MATRÍCULA
                            var cantidadMaterias = this.datos.cuantitativas.length;
                            if(cantidadMaterias == cantidadPromedios){
                                var me = this;
                                $.each(this.estadosMatricula, function(index, val) {
                                    if (val['id'] == 5) {
                                        me.nuevoEstadomatricula = val['estadoMatricula'];
                                    }
                                });
                                // CALCULAMOS EL ESTADO GENERAL DE ACUERDO AL PROMEDIO GENERAL ANUAL EN PRIMARIA en la gestion 2019
                                if (this.datos.gestion >= 2019 && this.datos.nivel == 12) {
                                    var sumaPromedios = 0;
                                    var promedioGeneralAnual;
                                    $.each(arrayPromedios, function(index, val) {
                                        sumaPromedios = sumaPromedios + val.promedio;
                                    });
                                    promedioGeneralAnual = Math.round(sumaPromedios/cantidadMaterias);

                                    if (promedioGeneralAnual < 51) {
                                        $.each(me.estadosMatricula, function(index, val) {
                                            if (val['id'] == 28) {
                                                me.nuevoEstadomatricula = val['estadoMatricula'];
                                            }
                                        });
                                    }

                                    this.nuevoPromedioGeneral = promedioGeneralAnual;

                                }else{
                                    $.each(arrayPromedios, function(index, val) {
                                        // NO CONSIDERAMOS LAS MATERIAS (ESPECIFICACMENTE PARA LA GESTION 2018)
                                        // 1052 CIENCIAS NATURALES: FISICA
                                        // 1053 CIENCIAS NATURALES: QUIMICA
                                        if(val.promedio < 51 && val.idAsignatura != 1052 && val.idAsignatura != 1053){
                                            $.each(me.estadosMatricula, function(index, val) {
                                                if (val['id'] == 11) {
                                                    me.nuevoEstadomatricula = val['estadoMatricula'];
                                                }
                                            });
                                        }
                                    });
                                }
                            }else{
                                var me = this;
                                $.each(this.estadosMatricula, function(index, val) {
                                    if (val['estadoMatricula'] == me.actualEstadomatricula) {
                                        me.nuevoEstadomatricula = val['estadoMatricula'];
                                    }
                                });
                            }
                        }else{
                            // CÁLCULO DE PROMEDIOS Y ESTADO DE MATRICULA PARA NOTAS TRIMESTRALES
                            $.each(this.datos.cuantitativas, function(index, val) {
                                nulos = 0;
                                suma1t = 0;
                                suma2t = 0;
                                suma3t = 0;
                                promedioAnual = 0;
                                reforzamiento = 0;
                                promedioFinal = 0;
                                $.each(val['notas'], function(index2, val2) {
                                    if (val2['idNotaTipo'] != 6 && val2['idNotaTipo'] != 7 && val2['idNotaTipo'] != 8 && val2['idNotaTipo'] != 9 && val2['idNotaTipo'] != 11) {
                                        var valor = val2['notaNueva'];
                                        if(valor == ''){
                                            valor = val2['nota'];
                                            if (valor == '') {
                                                valor = 0;
                                                nulos = nulos + 1;
                                            }
                                        }

                                        if (val2['idNotaTipo'] == 27 || val2['idNotaTipo'] == 30) {
                                            suma1t = suma1t + valor;
                                        }
                                        if (val2['idNotaTipo'] == 28 || val2['idNotaTipo'] == 31) {
                                            suma2t = suma2t + valor;
                                        }
                                        if (val2['idNotaTipo'] == 29 || val2['idNotaTipo'] == 32) {
                                            suma3t = suma3t + valor;
                                        }
                                    }

                                    if (val2['idNotaTipo'] == 6) {
                                        me.datos.cuantitativas[index].notas[index2].notaNueva = suma1t;
                                    }
                                    if (val2['idNotaTipo'] == 7) {
                                        me.datos.cuantitativas[index].notas[index2].notaNueva = suma2t;
                                    }
                                    if (val2['idNotaTipo'] == 8) {
                                        me.datos.cuantitativas[index].notas[index2].notaNueva = suma3t;
                                    }

                                    if (val2['idNotaTipo'] == 9) {
                                        promedioAnual = Math.round((suma1t + suma2t + suma3t)/3);
                                        me.datos.cuantitativas[index].notas[index2].notaNueva = promedioAnual;
                                    }else{
                                        if (val2['idNotaTipo'] == 10) {
                                            if (promedioAnual >= 36) {
                                                reforzamiento = 0;
                                            }else{
                                                reforzamiento = valor;
                                            }
                                            me.datos.cuantitativas[index].notas[index2].notaNueva = reforzamiento;
                                        }else{
                                            if (val2['idNotaTipo'] == 11 && reforzamiento != 0 && reforzamiento != '') {
                                                promedioFinal = promedioAnual + reforzamiento;
                                                me.datos.cuantitativas[index].notas[index2].notaNueva = promedioFinal;

                                                arrayPromedios.push({
                                                    idAsignatura: val['idAsignatura'],
                                                    promedio: promedioFinal
                                                });
                                                // INCREMENTAMOS LA CANTIDAD DE PROMEDIOS
                                                cantidadPromedios+=1;

                                            }else{
                                                if (val2['idNotaTipo'] == 11) {
                                                    me.datos.cuantitativas[index].notas[index2].notaNueva = 0;
                                                    
                                                    arrayPromedios.push({
                                                        idAsignatura: val['idAsignatura'],
                                                        promedio: promedioAnual
                                                    });
                                                    // INCREMENTAMOS LA CANTIDAD DE PROMEDIOS
                                                    cantidadPromedios+=1;
                                                }
                                            }
                                        }
                                    }
                                });
                            });

                            // CALCULAMOS EL ESTADO DE MATRÍCULA
                            var cantidadMaterias = this.datos.cuantitativas.length;
                            if(cantidadMaterias == cantidadPromedios){
                                var me = this;
                                $.each(this.estadosMatricula, function(index, val) {
                                    if (val['id'] == 5) {
                                        me.nuevoEstadomatricula = val['estadoMatricula'];
                                    }
                                });
                                // CALCULAMOS EL ESTADO GENERAL DE ACUERDO AL PROMEDIO GENERAL ANUAL EN PRIMARIA en la gestion 2019
                                $.each(arrayPromedios, function(index, val) {
                                    if(val.promedio < 36){
                                        $.each(me.estadosMatricula, function(index, val) {
                                            if (val['id'] == 11) {
                                                me.nuevoEstadomatricula = val['estadoMatricula'];
                                            }
                                        });
                                    }
                                });
                            }else{
                                var me = this;
                                $.each(this.estadosMatricula, function(index, val) {
                                    if (val['estadoMatricula'] == me.actualEstadomatricula) {
                                        me.nuevoEstadomatricula = val['estadoMatricula'];
                                    }
                                });
                            }
                        }                        

                    }

                },
                eliminarNotaCualitativa: function(row){
                    // this.notas.splice(pos,1);
                    var index = this.notasCualitativas.indexOf(row);

                    // cargamos la nota al valor de nueva nota
                    var me = this;
                    $.each(this.datos.cualitativas, function(index, val) {
                        if (val['idNotaTipo'] == row.idNotaTipo) {
                            me.datos.cualitativas[index].notaCualitativaNueva = '';
                        }
                    });

                    this.notasCualitativas.splice(index, 1);
                    var index1 = this.filasCualitativas.indexOf(row.idFila);
                    this.filasCualitativas.splice(index1,1);

                    $('#'+row.idFila).removeClass('seleccionado');
                    console.log(this.filas);
                },
               
                validarValorNotaCualitativa(notaCualitativa){
                    // cargamos la nota al valor de nueva nota
                    var me = this;
                    $.each(this.datos.cualitativas, function(index, val) {
                        if (val['idNotaTipo'] == notaCualitativa.idNotaTipo) {
                            me.datos.cualitativas[index].notaCualitativaNueva = notaCualitativa.notaNuevaCualitativa.toUpperCase();
                        }
                    });
                },
                getImage: function(event){
                    var informe = event.target.files[0];
                    var allowedExtensions = /(.jpg|.jpeg|.png|.gif|.pdf)$/i;
                    if(!allowedExtensions.exec(event.target.value)){
                        event.target.value = '';
                        Swal.fire(
                              'Archivo incorrecto!',
                              'El archivo adjunto debe ser una imagen o un archivo pdf',
                              'warning'
                            );
                        this.informe = '';
                        this.checkInforme = false;
                        return false;
                    }else{
                        var megas = (informe.size / 1024)/1024;
                        if (megas > 2) {
                            event.target.value = '';
                            Swal.fire(
                              'Tamaño no permitido!',
                              'El archivo debe tener un tamaño menor a 2MB',
                              'warning'
                            );
                            this.informe = '';
                            this.checkInforme = false;
                            return false;
                        }
                    }
                    this.informe = event.target.files[0];
                    console.log(this.informe);
                    this.checkInforme = true;
                },
                validate :function(evt){    
                    if(evt.target.value != "") {
                        if(evt.target.value>100)
                            evt.target.value = 100;
                        return false;
                    } else {
                        return true;
                    }
                },
                
                enviarSolicitud: function(){
                    
                    var obs = 0;
                     $.each(this.materiasnotas, function(index, val) {
                         console.log(val['nota']);
                         if(val['nota'] == '' || val['nota'] == 0 || val['nota'] == 'undefined' || val['nota']>100 || val['nota']<21 || isNaN( val['nota']) ){
                                  obs+=1;
                            }   
                    });

                    if(obs>0){
                        Swal.fire(
                          'Completar calificación!',
                          'Las calificaciones deben ser números y no pueden estar vacias o tener valor cero.',
                          'warning'
                        );
                        return;
                    }
                   
                    // VALIDAMOS QUE SE HAYA SELECCIONADO LA IMAGEN DEL INFORME
                    if (typeof this.informe != 'object') {
                        Swal.fire(
                          'Adjuntar Informe',
                          'Debe adjuntar el informe técnico, puede ser un archivo de imagen o PDF, y debe tener un tamaño menor a 2MB',
                          'warning'
                        );
                        return;
                    }

                    Swal.fire({
                        title: '¿Enviar solicitud?',
                        text: "La solicitud será enviada para revisión y aprobación de la Direccion Departamental",
                        type: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, enviar solicitud',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.value) {
                            
                            var data = new FormData();
                            data.append('idTramite', this.idTramite);
                            data.append('codigoRude', this.codigoRude);
                            data.append('estudiante', this.estudiante);
                            data.append('carnet', this.carnet);
                            data.append('complemento', this.complemento);
                            data.append('sie', this.sie);
                            data.append('institucioneducativa', this.institucioneducativa);
                            data.append('nivel', this.nivel);
                            data.append('grado', this.grado);
                            data.append('paralelo', this.paralelo);
                            data.append('turno', this.turno);
                            data.append('gestion', this.gestion);
                            data.append('departamento', this.departamento);
                            data.append('distrito', this.distrito);
                            data.append('flujoTipo', this.flujoTipo);
                            data.append('notas', JSON.stringify(this.materiasnotas));
                            data.append('informe', this.informe);
                            data.append('dataInscription', JSON.stringify(this.RequestInscriptionSelected));

                            this.formularioEnviado = true;
                                
                            axios.post(Routing.generate('tramite_regularizacion_historial_formulario_save'), data)
                            .then(response => {
                                // window.location.href = "{{path('wf_tramite_index', { tipo: 3 })}}";
                                this.respuestaIdTramite = response.data.idTramite;
                                this.urlreporte = response.data.urlreporte;

                                document.location.href = "#tramiteEnviado";
                                
                            })
                            .catch(e => {
                                this.formularioEnviado = false;
                                Swal.fire(
                                  'No se pudo enviar la solicitud!',
                                  '',
                                  'error'
                                );
                            });
                        }
                    })
                }
            },
            mounted(){
            }
        });

        // $(document).ready(function(){
        //     $('[data-toggle="tooltip"]').tooltip();
        //     $('[data-toggle="popover"]').popover();
        //     // $("td").focus();
        //     console.log('adsfadsfsadf');
        // });

        $(".jnumbersletters").keypress(function (key) {
            var key = key || window.event;
            var k = key.charCode || key.keyCode;
            if ((k < 97 || k > 122)//letras minusculas
                && (k < 65 || k > 90) //letras mayusculas
                && (k < 48 || k > 57) //NUmeros
                // && (k != 13) //ENTER
                && (k != 8) //retroceso
                && (k != 9) //tab
                && (k != 241) //ñ
                 && (k != 209) //Ñ
                 && (k != 32) //espacio
                 && (k != 225) //á
                 && (k != 233) //é
                 && (k != 237) //í
                 && (k != 243) //ó
                 && (k != 250) //ú
                 && (k != 193) //Á
                 && (k != 201) //É
                 && (k != 205) //Í
                 && (k != 211) //Ó
                 && (k != 218) //Ú
                 && (k != 44) //coma ,
                 && (k != 46) //punto .
                )
                return false;
        });

    </script>
{% endblock %}