{% extends 'layoutHerramienta.html.twig' %}
{% block contentoption %}
    <div class="header-content">
        <h2><i class="fa fa-table animated fadeIn"></i> Formulario de Solicitud BTH. -  {{ tramite_tipo }}</h2>
        <div class="breadcrumb-wrapper hidden-xs">
            <span class="label">Usted esta aquí:</span>
            <ol class="breadcrumb">
                <li>
                    <i class="fa fa-home"></i>
                    <a href="#">Solicitud BTH </a>
                    <i class="fa fa-angle-right"></i>
                </li>
                <li class="active">Index</li>
            </ol>
        </div>
    </div>
    <div class="body-content animated fadeIn">
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="panel">
                    <div class="panel-body">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <h3 class="panel-title">Nro. Trámite: <b>{{ id_tramite }}</b> Formulario de Solicitud BTH </h3>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">1.- Personal Administrativo </h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <b>Director(a)</b>
                                                </div>
                                                <div class="col-md-9">
                                                    {{ director.paterno ~' '~ director.materno ~' '~ director.nombre }}
                                                </div>
                                                <div class="col-md-3">
                                                    <b>Carnet de Identidad</b>
                                                </div>
                                                <div class="col-md-9">
                                                    {{ director.carnet }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">2.- Información General</h3>
                                        </div>
                                        <div class="panel-body">
                                            {% set iedu = ieducativa[0] %}
                                            {% set iedusu = ieducativa[1] %}
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <b>Código RUE</b>
                                                </div>
                                                <div class="col-md-9">
                                                    {{ institucion.id }}
                                                </div>
                                                <div class="col-md-3">
                                                    <b>Unidad Educativa</b>
                                                </div>
                                                <div class="col-md-9">
                                                    {{ iedu.institucioneducativa }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">3.- Localización</h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <b>Departamento</b>
                                                </div>
                                                <div class="col-md-3">
                                                    {{ ubicacion['departamento'] }}
                                                </div>
                                                <div class="col-md-3">
                                                    <b>Localidad</b>
                                                </div>
                                                <div class="col-md-3">
                                                    {{ ubicacion['localidad'] }}
                                                </div>
                                                <div class="col-md-3">
                                                    <b>Cantón</b>
                                                </div>
                                                <div class="col-md-3">
                                                    {{ ubicacion['canton'] }}
                                                </div>
                                                <div class="col-md-3">
                                                    <b>Zona</b>
                                                </div>
                                                <div class="col-md-3">
                                                    {{ ubicacion['zona'] }}
                                                </div>
                                                <div class="col-md-3">
                                                    <b>Distrito</b>
                                                </div>
                                                <div class="col-md-3">
                                                    {{ ubicacion['distrito'] }}
                                                </div>
                                                <div class="col-md-3">
                                                    <b>Dirección</b>
                                                </div>
                                                <div class="col-md-3">
                                                    {{ ubicacion['direccion'] }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">4.- Cumplimiento de Requisitos</h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <b>Informe</b>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="ckbox ckbox-theme">
                                                        <input id="informe"  type="checkbox">
                                                        <label for="informe"></label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">5.- Año de escolaridad</h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="alert alert-info">
                                                <span class="alert-icon"><i class="fa fa-bell-o"></i></span>
                                                <div class="notification-info">
                                                    <b>Nota</b> Una vez aprobada la solicitud BTH con el año de escolaridad correcto, por ningún motivo se retirarán de la formación Técnica Tecnológica del Bachillerato Técnico Humanístico en ningún año de escolaridad.
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <b>Año de Escolaridad a implementar BTH:</b><br>
                                                    <b><span>Nivel: Secundario</span></b>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label for="grado"><b>Año de escolaridad</b></label>
                                                        <select id="form_grado" name="form[grado]" required="required" class="form-control" onchange="showGrado(this)">
                                                            <option value="" selected="selected" disabled>Seleccione...</option>
                                                            {% for keygrado, selectGrado in grados %}
                                                                <option value="{{ keygrado }}">{{ selectGrado }}</option>
                                                            {% endfor %}
                                                        </select>                                                
                                                    </div>
                                                </div>
                                                <div class="col-md-4 text-center">
                                                    <p><b>Grado Seleccionado</b></p>
                                                    <p id="literal_grado" style="font-size: 50px; font-weight: bold; color: green">-</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">6.- Especialidad</h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="lista_select_especialidad"><b>Especialidades habilitadas</b></label>
                                                        <select data-placeholder="Seleccionar especialidad" id="lista_select_especialidad" class="chosen-select" name="lista_select_especialidad[]"  class="form-control" multiple=""  >
                                                        {% for especialidadarray in especialidadarray %}
                                                            <option value="{{ especialidadarray.id }}" disabled="disabled" >{{ especialidadarray.especialidad }}</option>
                                                        {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="select_especialidad_r"><b>Adicionar especialidades</b></label>
                                                        {% if (tramite_tipo == 'Registro Nuevo')  %} {#tramite Nuevo#}
                                                        <select  id="select_especialidade_n" name="select_especialidade_n[]" class="chosen-select" multiple="" tabindex="-1" style="display: none;">
                                                            {% for especialidad in especialidad_adicionar %}
                                                            <option value="{{ especialidad.id }}">{{ especialidad.especialidad }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        {% else %}{#tramite Ratificacion#}
                                                        <select  id="select_especialidade_r" name="select_especialidade_r[]" class="chosen-select" multiple="" tabindex="-1" style="display: none;">
                                                            {% for especialidad in especialidad_adicionar %}
                                                            <option value="{{ especialidad.id }}">{{ especialidad.especialidad }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <b>Documento adjunto</b><br>
                                                </div>
                                                <div class="col-md-9">
                                                    <a class="btn btn-lilac btn-xs btn-stroke" href="{{asset('uploads/archivos/flujos/'~institucion.id~'/'~'bth/'~ documento )}}" target="_blank">
                                                        <i class="fa fa-file-pdf-o fa-2x" ></i> Informe Enviado por la Dirección Distrital
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12 text-center"><br>
                                                    <button class="btn btn-sm btn-facebook" id="enviarSolicitud_bth"  title="Enviar Solicitud" onclick="enviarSolicitubthDis()"><i class="fa fa-send"></i> Enviar Solicitud</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input  type="hidden" id="tramite_tipo"  value="{{ tramite_tipo }}">
    </div>
{% endblock %}
{% block javascripts%}
    {{ parent() }}
    <script>
        $(document).ready(function(){
            var informe = {{ informe }};
            if(informe==1){
                document.getElementById("informe").checked = true;
            }
            $('#obs').hide();
            var select_array = [];
            var mensaje =false;
            $('#lista_select_especialidad').find('option').each(function () {
                if(this.value == 3 || this.value == 4 ){
                    mensaje =true;
                }
                select_array.push(this.value);
            });
            setTimeout(function () {
                $("#lista_select_especialidad").val(select_array).trigger('chosen:updated');
            },500);
            if (mensaje){
                swal({
                    icon: "warning",
                    text: "Una o todas de sus especialidades con las que cuenta su Unidad Educativa se vio afectada con la actualización de especialidades - 2019.",
                    value: true,
                    visible: true,
                    className: "",
                    closeModal: true,
                    button: "Entendido",
                });
            }
        });
        function muestraobs(){
            var respuesta=$('input:radio[name=radiotype1]:checked').val();
            if(respuesta=='si'){
                $('#obs').hide();
            }else {
                $('#obs').show(2000);
            }
        }
        function  enviarSolicitubthDis() {
            var idsolicitud  = {{ tipoTramite }};
            var tramite_tipo = $('#tramite_tipo').val();
            switch (tramite_tipo) {
                case 'Registro Nuevo'://Registro Nuevo
                    swal({
                        title: "¿Está Segura/o de enviar los valores introducidos en el formulario?",
                        text: "La información llenada será enviada a la Direccion Distrital.",
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                        buttons: ["Cancelar", "Continuar"],
                    })
                        .then(function(willDelete)  {
                            if (willDelete) {
                                var institucionid={{ institucion.id }};
                                var ip = [];
                                var gradoSelected = $('#form_grado').val();
                                
                                if($('#informe:checked').val())
                                    ip.push({ informe : 1});
                                else ip.push({ informe : 0 });
                                ip.push({institucionid : institucionid});
                                if($('#select_especialidade_n').val())
                                    ip.push({select_especialidad : $('#select_especialidade_n').val()});
                                else
                                {swal("Debe seleccionar al menos una especialidad."); return false;}
                                var obstxt=$('#obstxt').val();
                                ip.push({grado:gradoSelected});
                                var ipt=JSON.stringify(ip);
                                var imagen = '{{ asset("img/loading96.gif") }}';
                                $('#enviarSolicitud_bth').attr("disabled", true);
                                $.ajax({
                                    type: 'post',
                                    url: "{{ path('solicitud_bth_enviosolicitud') }}",
                                    data:{ipt: ipt,id_distrito: {{ ubicacion['codigo_distrito'] }},institucionid:{{ institucion.id }},id_tramite:{{ id_tramite}},idsolicitud:idsolicitud,solicitud:tramite_tipo,idflujotipo:{{ flujotipo }},sw:1 },
                                    dataType : 'json',
                                    beforeSend: function () {
                                        swal({
                                            title: "Enviando...",
                                            text: "Espere un momento por favor",
                                            icon: imagen,
                                            buttons: false
                                        });
                                    },
                                    success: function (data) {
                                        //console.log(data);
                                        if (data.estado ==1 ){
                                            swal("Su formulario se ha enviado con éxito, con Nro. Trámite: " + {{ id_tramite}} );                                           
                                            location.href = "{{ path('wf_tramite_index') }}";
                                        }
                                        else if(data.estado ==2 ){
                                            swal("Debe iniciar su trámite como 'Ratificacion'");
                                        }else if(data.estado == 4){
                                            swal(data.msg)
                                        }
                                        else {
                                            swal('Su formulario no se envío correctamente');
                                        }
                                    },
                                    complete: function () {
                                        swal.stopLoading();
                                        swal.close();
                                    }
                                });
                            }
                        });
                    break;
                case 'Ratificación': //Ratificacion
                    swal({
                        title: "¿Está Segura/o de enviar los valores introducidos en el formulario?",
                        text: "La información llenada será enviada a la Direccion Distrital.",
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                        buttons: ["Cancelar", "Continuar"],
                    })
                        .then(function(willDelete)  {
                            if (willDelete) {
                                var institucionid={{ institucion.id }}
                                var tipoTramite={{ tipoTramite }}
                                var ip = [];
                                var gradoSelected = $('#form_grado').val();
                                
                                if($('#informe:checked').val())
                                    ip.push({ informe : 1});
                                else ip.push({ informe : 0 });
                                ip.push({institucionid : institucionid});
                                var especialidades_id = [];
                                if($('#select_especialidade_r').val())
                                    ip.push({select_especialidad : $('#select_especialidade_r').val()});
                                else
                                {swal("Debe seleccionar al menos una especialidad."); return false;}

                                
                                //ip.push({"select_especialidad" : especialidades_id});
                                var obstxt=$('#obstxt').val();
                                ip.push({grado:gradoSelected});
                                var ipt=JSON.stringify(ip);
                                var imagen = '{{ asset("img/loading96.gif") }}';
                                $('#enviarSolicitud_bth').attr("disabled", true);
                                $.ajax({
                                    type: 'post',
                                    url: "{{ path('solicitud_bth_enviosolicitud') }}",
                                    data:{ipt: ipt,id_distrito: {{ ubicacion['codigo_distrito'] }},institucionid:{{ institucion.id }},id_tramite:{{ id_tramite}},idsolicitud:idsolicitud,tipoTramite:{{ tipoTramite }},idflujotipo:{{ flujotipo }},sw:1},
                                    dataType : 'json',
                                    before: function () {
                                        swal({
                                            title: "Enviando...",
                                            text: "Espere un momento por favor",
                                            icon: imagen,
                                            buttons: false
                                        });
                                    },
                                    success: function (data) {
                                        console.log(data);
                                        if (data.estado==1){
                                            swal("Su formulario se ha enviado con éxito, con Nro. de Trámite:"+{{ id_tramite}} );
                                            location.href = "{{ path('wf_tramite_index', {'tipo':2}) }}";
                                            
                                        }
                                        else if(data.estado==3 ){
                                            swal("Debe iniciar su trámite como 'Registro Nuevo'");
                                        }else if(data.estado == 4){
                                            swal(data.msg)
                                        }
                                        else {
                                            swal('Su formulario no se envío correctamente');
                                        }
                                    },
                                    complete: function () {
                                        swal.stopLoading();
                                        swal.close();
                                    }
                                });
                            }
                        });
                    break;
                default:
                break;
            }
        }
        function showGrado(params) {
            $('#literal_grado').text(params.value);
        }
    </script>
{% endblock %}
