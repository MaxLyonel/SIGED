<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<title>SIGEE</title>
	<link rel="stylesheet" type="text/css" href="{{asset('webGis/bootstrap4/dist/css/bootstrap.min.css')}}">
	<link rel="stylesheet" type="text/css" href="{{asset('webGis/fontawesome/css/font-awesome.min.css')}}">
	<link rel="stylesheet" type="text/css" href="{{asset('webGis/css/animate.css')}}">
	<style type="text/css">
		body, #map{
			position: absolute;
			top: 0;
			left: 0;
			width: 100% !important;
			height: 100% !important;
			background-color: grey
		}
		.menu{
			position: absolute;
			padding: 0px;
			width: 350px;
			height: 100%;
			background-color: #ffffff;
			top: 0;
			/*display: none;*/
			overflow-y: auto;
			box-shadow: 3px 3px 5px #BCC4E5;
			z-index: 1005;
		}
		.menu-header{
			background-color: #0A60FE;
			color: #FFFFFF;
			text-align: left;
			margin: 0px;
			margin-bottom: 5px;
			padding: 5px 0 3px 20px;
		}

		.menu-search{
			padding: 0 10px 0 10px;
			margin-bottom: 5px;
		}

		.menu-result{
			padding: 10px;
		}

		.menu p{
			font-size: 0.9em;
		}

		.ui-autocomplete {
			display: none;
		    max-height: 0px;
		    overflow-y: auto;
		    /* prevent horizontal scrollbar */
		    overflow-x: hidden;
  		}

		#result{
			height: auto;
			max-height: 150px;
			background-color: #FFFFFF;
			overflow-y: auto;
			padding: 5px;
		}
		#result li{
			list-style: none;
			padding: 4px;
			margin: 0px;
			border-bottom: 2px solid #EEEEEE;
			background-color: #FFFFFF;
		}
		#result li:hover{
			background-color: #EEEEEE;
		}
		#result a{
			text-decoration: none;
			color: #898A9C;
		}
		.tab-panel{
			padding: 10px 0 10px 0;
		}
		.btn-menu{
			position: absolute;
			margin-top:3px;
			margin-left: -2px;
			z-index: 10;
			background-color: #0A60FE;
			color:#ffffff;
			display: none;
			font-size: 1.1em;
			cursor: pointer;
		}
		.btn-login{
			position: absolute;
			top:10px;
			right:10px;
		}
		#institucion{
			text-transform: none; 
		}
		.result-detalle{
			/* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#e3ebf2+0,ffffff+100 */
			background: #e3ebf2; /* Old browsers */
			background: -moz-linear-gradient(top, #e3ebf2 0%, #ffffff 100%); /* FF3.6-15 */
			background: -webkit-linear-gradient(top, #e3ebf2 0%,#ffffff 100%); /* Chrome10-25,Safari5.1-6 */
			background: linear-gradient(to bottom, #e3ebf2 0%,#ffffff 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#e3ebf2', endColorstr='#ffffff',GradientType=0 ); /* IE6-9 */
		}
		#detalle{
			margin: 20px;
		}
		#detalle h6{
			color: #0B43FD;/*#299AFF;*/
		}
		.coordenadas{
			position: absolute;
			height: auto;
			width: 600px;
			top: 20px;
			left:50%;
			margin-left:-300px;
			background-color: #FFFFFF;
			display: none;
			padding: 10px;
		}
		.menu .alert-danger{
			padding: 3px;
			text-align: center;
		}

		.jupper{
			text-transform: uppercase;
		}

		.btn-ayuda{
			margin-right: 5px;
			border-radius: 3px;
		}

		.numeroPaso{
			font-size: 1em;
			padding: 2px;
			color: #0071E7;
		}
		.footer{
			position: absolute;
			width: 100%;
			bottom: 0px;
			text-align: center;
			z-index: 1000;
			font-size: 0.9em;
			/*background-color: #EEEEEE;
			opacity: 0.5;*/
			padding-top: 5px;
			padding-bottom: 5px;
			color: #1733B2;
			font-weight: bold;
		}

	</style>
</head>
<body>
	<div id="map"></div>

	<button type="button" class="btn-menu btn" data-container="body" data-toggle="popover" data-placement="top" data-content="Buscar Institución Educativa" data-trigger="hover" onclick="mostrarMenu();"> <b><i class="fa fa-chevron-right"></i></b></button>
	<div class="btn-login btn-group">
		<a href="#" data-container="body" data-toggle="popover" data-placement="top" data-content="Descargar manual de usuario" data-trigger="hover"><button class="btn-ayuda">  <i class="fa fa-question-circle"></i>  </button></a>
		{% if app.user %}
		  	<button type="button" id="btn-user" class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		    	 <small> <i class="fa fa-user"></i> &nbsp; {{app.user.persona.nombre}}</small>
		  	</button>
		  	<div class="dropdown-menu dropdown-menu-right">
		    	<a href="{{path('logout')}}"><button class="dropdown-item btn-sm" type="button"> <i class="fa fa-lock"></i> Salir</button></a>
		  	</div>
		{% else %}    
			<a href="{{path('sie_gis_login')}}" class="btn btn-primary btn-sm" data-toggle="tooltip" data-placement="right" title="Tooltip on top"><small>Iniciar Session</small></a>
		{% endif %}
	</div>

	<div class="menu">
		<div class="menu-header">
			<h3>SIGEE <a href="#" style="float:right; font-size:0.7em; margin: 10px 10px 0 0; color:#FFFFFF; text-decoration:none" onclick="ocultarMenu();" data-container="body" data-toggle="popover" data-placement="top" data-content="Ocultar menu" data-trigger="hover"> <i class="fa fa-chevron-left"></i> </a></h3>
		</div>
		<div class="menu-search">
			<ul id="tabsJustified" class="nav nav-tabs">
                <li class="nav-item"><a href="" data-target="#tab1" data-toggle="tab" class="nav-link small text-uppercase active">Sie</a></li>
                <li class="nav-item"><a href="" data-target="#tab2" data-toggle="tab" class="nav-link small text-uppercase">Nombre</a></li>
                <li class="nav-item"><a href="" data-target="#tab3" data-toggle="tab" class="nav-link small text-uppercase">Código Edificio</a></li>
            </ul>
            <br>
            <div id="tabsJustifiedContent" class="tab-content">
                <div id="tab1" class="tab-pane fade active show">
                    <div class="input-group">
			  			<div class="input-group-addon"> <i class="fa fa-search"></i> </div>
			  			<input type="text" id="sie" name="sie" class="form-control" placeholder="Código SIE" maxlength="8">
			  		</div>
                </div>
                <div id="tab2" class="tab-pane fade">
                    <div class="input-group">
			  			<div class="input-group-addon"> <i class="fa fa-search"></i> </div>
			  			<input type="text" id="institucion" name="institucion" class="form-control" placeholder="Nombre de la Institución Educativa" maxlength="30" value="">
			  		</div>
                </div>
                <div id="tab3" class="tab-pane fade">
                    <div class="input-group">
			  			<div class="input-group-addon"> <i class="fa fa-search"></i> </div>
			  			<input type="text" id="edificio" name="edificio" class="form-control" value="" placeholder="Código de Edificio Educativo" maxlength="10">
			  		</div>
                </div>
            </div>
		</div>
  		<div class="menu-result">
  			<div class="result-header">
  			</div>
  			<div class="result-body">
  				<ul id="result"></ul>
  			</div>
			<div class="result-detalle">
				<div id="detalle"></div>
			</div>
  		</div>
	</div>

	<div class="footer">
		Sistema de Información Geográfica de Edificios Educativos
	</div>

	<div class="coordenadas">
		<h6> <b id="numeroPaso" class="numeroPaso"></b> Editar Ubicación Georeferencial</h6>
		<div id="msgActualizacion"></div>
		<div class="text-center" style="padding:5px 0 0 0; background-color:#F9F5F1; margin-bottom:5px">
			<small>Código de Edificio</small> 
			<h2 class="coordenadasCodEdificio"></h2>
		</div>
		<div class="row">
			<div class="col-sm-12">
				<button class="btn btn-link" onclick="ingresarCoordenadas();" data-container="body" data-toggle="popover" data-placement="top" data-content="Puede ingresar las coordenadas geográficas manualmente" data-trigger="hover"> <small> <i class="fa fa-search"></i> Buscar por coordenadas </small></button>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-4">
				<small>Latitud</small>
				<div class="latitud"></div>
			</div>
			<div class="col-sm-4">
				<small>Longitud</small>
				<div class="longitud"></div>
			</div>
			<div class="col-sm-4">
				<button class="btn btn-secondary btn-sm" onclick="cerrarGeoreferencial();"><small>Cancelar</small></button>
				<button class="btn btn-primary btn-sm" onclick="updateGeoreferencial();"><small>Guardar Cambios</small></button>
			</div>
		</div>
	</div>

	<!-- Modal -->
	<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  	
	</div>

	<div class="modal fade" id="modal2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  	<div class="modal-dialog" role="document">
	  	    <div class="modal-content">
	  	    	<div class="modal-header">
	  			  	<h6 class="modal-title" id="exampleModalLabel">Ingresar coordenadas geográficas</h6>
	  			  	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
	  			    	<span aria-hidden="true">&times;</span>
	  			  	</button>
	  			</div>
  				<div class="modal-body">
  					<div class="row">
	  					<div class="col-md-6">
	  						<input type="text" class="form-control" placeholder="Latitud" id="bLatitud">
	  					</div>
	  					<div class="col-md-6">
	  						<input type="text" class="form-control" placeholder="Longitud" id="bLongitud">
	  					</div>
  					</div>
  				</div>
  				<div class="modal-footer">
  				  	<button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal"><small>Cancelar</small></button>
  				  	<button type="submit" class="btn btn-primary btn-sm" onclick="buscarCoordenadas();"><small>Buscar</small></button>
  				</div>
	  		</div>
	  	</div>
	</div>


	<script type="text/javascript" src="{{asset('webGis/js/jquery.min.js')}}"></script>
	<!--script type="text/javascript" src="{{asset('webGis/js/jquery-3.2.1.min.js')}}"></script-->
	<script type="text/javascript" src="{{asset('webGis/bootstrap4/dist/js/popper.js')}}"></script>
	<script type="text/javascript" src="{{asset('webGis/bootstrap4/dist/js/bootstrap.min.js')}}"></script>

	<script type="text/javascript" src="{{asset('webGis/js/jquery-ui.min.js')}}"></script>
	<script type="text/javascript" src="{{asset('webGis/js/jquery.alphanum.js')}}"></script>
	<script type="text/javascript" src="{{asset('webGis/js/notify.js')}}"></script>

	<script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
	<script src="{{ path('fos_js_routing_js', {"callback": "fos.Router.setData"}) }}"></script>

	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="{{asset('webGis/google-maps-extensions/google.maps.Polygon.contains.js')}}"></script>
	<script type="text/javascript" src="{{asset('webGis/google-maps-extensions/google.maps.Polygon.getBounds.js')}}"></script>
	
	<script type="text/javascript">

		$(function () {
		    $('[data-toggle="tooltip"]').tooltip();
	  		$('[data-toggle="popover"]').popover();
		})
		/* INICIALIZAR VARIABLES*/

		var map;
		var myLatLng;
		var marker;
		var contMarker = 1;
		var infowindow;
		var image = "{{asset('images/marker.png')}}";
		var contentString;
		var poligono;
		var cordsPoligono;
		var latitud;
		var longitud;
		var latitudPreview;
		var longitudPreview;
		var codigoEdificio;

		var tipoBusqueda;
		var codigo;

		var idComunidadNext = 'Ninguno';
		var idComunidad = 'Ninguno';
		var actualizarGeo = false;

		/* FUNCIONES PARA MANIPULAR EL MENU */

		function mostrarMenu(){
			$('.menu').fadeIn(400);
			$('.btn-menu').fadeOut(300);
		}
		function ocultarMenu(){
			$('.menu').fadeOut(400);
			$('.btn-menu').fadeIn(500);
		}

		function limpiarDatos(){
			if(marker){marker.setMap(null);}
			if (poligono) {poligono.setMap(null);}
			$('#result').empty();
			$('#detalle').empty();
		}

		$( ".nav-item" ).click(function() {
  			limpiarDatos();
  			$('#sie').val('');
  			$('#institucion').val('');
  			$('#edificio').val('');
  			//map.setZoom(6);

		});

		/* INICIALIZAR MAPA */

		function initMap() {
			myLatLng = {lat:-16.507675, lng:-68.126159};
		    map = new google.maps.Map(document.getElementById('map'), {
		        center: myLatLng,
		        zoom: 6,
		        minZoom: 3,
		        mapTypeId: google.maps.MapTypeId.ROADMAP,
		        disableDefaultUI: true,
		        zoomControl: true,
		        mapTypeControl: true,
		        mapTypeControlOptions: {
    				style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
    				position: google.maps.ControlPosition.RIGHT_CENTER
    			},
		        scaleControl: true,
		        streetViewControl: false,
		        rotateControl: false,
		        fullscreenControl: false
		    });
		}

		initMap();

		/* VALIDACION DE MARCADOR */

		function validarPosicion(){
			var estado = poligono.contains(marker.getPosition());
		    if (estado) {
		    	console.log(marker.getPosition().lat());
		        console.log(marker.getPosition().lng());
		    	console.log('Si es valido');
		    }else{
		    	console.log('No es valido');
		    }
		}

		function validar(){
			var latitud = $('#latitud').val();
			var longitud = $('#longitud').val();
			if(!confirm('Las coordenadas que se registrarán son:\n \n Latitud: '+latitud+'\n Longitud: '+longitud+'\n \nEsta seguro de guardar los cambios?')){
				return false;
			}
		}

		/**
		 * VALIDACION DE TIPOS DE DATOS
		 */
		$('#sie').numeric();
		$('#edificio').numeric();

		/* BUSQUEDA POR SIE */
		$('#sie').on('keyup', function(){
			if(this.value.length < 8){
				limpiarDatos();
			}
		});

		$('#sie').autocomplete({
		    minLength: 8,
		    source: function(request, response){
		        $.ajax({
		            url: Routing.generate('sie_gis_searching',{'sie':request.term, 'tipo':'sie'}),
		            dataType: "json",
		            beforeSend: function(){
		            	$('#result').empty();
		            	$('#detalle').empty();
		            	$('#result').append('<div class="loading" style="text-align:center; padding:20px 0 20px 0; color:#5DABFB; font-size:13px;"><img src="{{asset("img/loading.gif")}}" width="20px"/> <br> Cargando... </div>');
		            },
		            success: function(data){
		            	tipoBusqueda = 'sie';
	            		$('#result').empty();
	            		$('#detalle').empty();
	            		if (data.length === 0) {
	            			$('#result').append('<li> <i class="fa fa-info-circle"></i> No hay resultados</li>');
	            		}else{
		            	    response(
		            	        $.each(data, function(i, value){
		            	            $('#result').append('<a href="#" onclick="seleccionarUnidad('+i+');"><li> <i class="fa fa-home" style="font-size:1.5em; float:left;"></i> <div style="margin-left:30px; font-size:0.8em"><div>SIE: <b style="color:#299AFF">'+value.sie+'</b> <small style="float:right">'+value.departamento+'</small> </div><div> I.E.: '+value.institucioneducativa+'</div></div></li></a>');
		            	        }));
	            		}
		            },
		            error: function(data){
		            	$('#result').empty();
		            	$('#result').append('<div class="alert-danger"><small> <i class="fa fa-warning"></i> No se puede completar la petición. </small> </div>');
		            }		        	
		        });
		    }
		});

		/* BUSQUEDA POR NOMBRE DE INSTITUCION */

		$('#institucion').on('keyup', function(){
			if(this.value == ""){
				limpiarDatos();
			}
		});

		$('#institucion').autocomplete({
		    minLength: 3,
		    source: function(request, response){
		        $.ajax({
		            url: Routing.generate('sie_gis_searching',{'institucion':request.term,'tipo':'nombre'}),
		            dataType: "json",
		            beforeSend: function(){
		            	$('#result').empty();
		            	$('#detalle').empty();
		            	$('#result').append('<div class="loading" style="text-align:center; padding:20px 0 20px 0; color:#5DABFB; font-size:13px;"><img src="{{asset("img/loading.gif")}}" width="20px"/> <br> Cargando... </div>');
		            },
		            success: function(data){
		            	tipoBusqueda = 'nombre';
	            		$('#result').empty();
	            		$('#detalle').empty();
	            		if (data.length === 0) {
	            			$('#result').append('<li> <i class="fa fa-info-circle"></i> No hay resultados</li>');
	            		}else{
	            			//$('#result').append('<small style="text-align:right">'+  +' resultados</small>');
		            	    response(
		            	        $.each(data, function(i, value){
		            	            $('#result').append('<a href="#"><li onclick="seleccionarUnidad('+value.sie+');" data-container="body" data-toggle="popover" data-placement="right" data-content="Zona: '+value.zona+' Dirección: '+value.direccion+'" data-trigger="hover"><i class="fa fa-home" style="font-size:1.5em; float:left;"></i> <div style="margin-left:30px; font-size:0.8em"><div>SIE: <b style="color:#299AFF">'+value.sie+'</b> <small style="float:right">'+value.departamento+'</small> </div><div> I.E.: '+value.institucioneducativa+'</div></div></li></a>');
		            	        }));
	            		}

	            		$('[data-toggle="popover"]').popover();
		            },
		            error: function(data){
		            	$('#result').empty();
		            	$('#result').append('<div class="alert-danger"><small> <i class="fa fa-warning"></i> No se puede completar la petición. </small> </div>');
		            }		        	
		        });
		    }
		});

		/* BUSQUEDA POR CODIGO DE EDIFICIO */
		$('#edificio').on('keyup', function(){
			if(this.value.length < 8){
				limpiarDatos();
			}
		});

		$('#edificio').autocomplete({
		    minLength: 8,
		    source: function(request, response){
		        $.ajax({
		            url: Routing.generate('sie_gis_searching',{'edificio':request.term, 'tipo':'edificio'}),
		            dataType: "json",
		            beforeSend: function(){
		            	$('#result').empty();
		            	$('#detalle').empty();
		            	$('#result').append('<div class="loading" style="text-align:center; padding:20px 0 20px 0; color:#5DABFB; font-size:13px;"><img src="{{asset("img/loading.gif")}}" width="20px"/> <br> Cargando... </div>');
		            },
		            success: function(data){
		            	tipoBusqueda = 'edificio';
	            		$('#result').empty();
	            		$('#detalle').empty();
	            		if (data.length === 0) {
	            			$('#result').append('<li> <i class="fa fa-info-circle"></i> No hay resultados</li>');
	            		}else{
		            	    response(
		            	        $.each(data, function(i, value){
		            	            $('#result').append('<a href="#" onclick="seleccionarEdificio('+i+');"><li> <i class="fa fa-home" style="font-size:1.5em; float:left;"></i> <div style="margin-left:30px; font-size:0.8em"><div>COD. EDIFICIO: <b style="color:#299AFF">'+value.edificio+'</b> <small style="float:right">'+value.departamento+'</small> </div></div></li></a>');
		            	        }));
	            		}
		            },
		            error: function(data){
		            	$('#result').empty();
		            	$('#result').append('<div class="alert-danger"><small> <i class="fa fa-warning"></i> No se puede completar la petición. </small> </div>');
		            }		        	
		        });
		    }
		});

		function seleccionarUnidad(i){
			$.ajax({
				type:'post',
				url: Routing.generate('sie_gis_seleccionar_unidad',{'ie':i}),
				beforeSend: function(){
					$('#detalle').empty();
					$('#detalle').append('<div style="text-align:center; padding:20px 0 20px 0; color:#5DABFB; font-size:13px;"><img src="{{asset("img/loading.gif")}}" width="20px"/> <br> Cargando... </div>');
				},
				success: function(data){

					codigoEdificio = data.codEdificio;
					idComunidad = data.idComunidad;
					idComunidadNext = data.idComunidad;

					codigo = i;
					$('#detalle').empty();
					if(marker){
						marker.setMap(null);
					}
					if(data.coordenadas == true){
					    // Construimos el marcador
					    marker = new google.maps.Marker({
					        position: {lat: data.latitud, lng:data.longitud},
					        map: map,
					        title: 'Edificio Escolar',
					        draggable: false
					    });

					    // Centrar el map
					    map.setCenter(myLatLng);

					    contentString = '<div>Código SIE</div>'+
					    				'<b>'+data.id+'</b>'+
					    				'<div>Institución Educativa</div>'+
					    				'<b>'+data.institucioneducativa+'</b>';

					    infowindow = new google.maps.InfoWindow({
					        content: contentString
					    });

					    marker.addListener('click', function() {
					        infowindow.open(map, marker);
					    });

					    marker.addListener('dblclick', function() {
					        //map.setZoom(15);
					    });
					}

					map.setZoom(6);

					$('#detalle').append('<h6 style="padding-top:10px"><i class="fa fa-file-text-o"></i> Información</h6>'+
										  '<div><small>Código de Edificio</small></div>'+
										  '<div><b>'+data.codEdificio+'</b></div>'+
										  '<div><small>Zona</small></div>'+
										  '<div><b>'+data.zona+'</b></div>'+
										  '<div><small>Dirección</small></div>'+
										  '<div><b>'+data.direccion+'</b></div>'+
										  '<hr>'+
									      '<div><small>Código SIE</small></div>'+
										  '<div><b>'+data.id+'</b></div>'+
										  '<div><small>Institución Educativa</small></div>'+
										  '<div><b>'+data.institucioneducativa+'</b></div>'+
										  '<hr>'+
										  '<h6><i class="fa fa-map-o"></i> Ubicación Geográfica</h6>'+
										  '<div><small>Departamento</small></div>'+
										  '<div class="jupper"><b>'+data.departamento+'</b></div>'+
										  '<div><small>Provincia</small></div>'+
										  '<div class="jupper"><b>'+data.provincia+'</b></div>'+
										  '<div><small>Municipio</small></div>'+
										  '<div class="jupper"><b>'+data.municipio+'</b></div>'+
										  '<div><small>Comunidad</small></div>'+
										  '<div class="jupper"><b>'+data.comunidad+'</b></div>'+
										  '<div class="text-right" id="actGeografica"></div>'+
										  '<hr>'+
										  '<h6> <i class="fa fa-map-marker"></i> Ubicación Georeferencial</h6>'+
										  '<div id="validacionMsg"></div>'+
										  '<div><small>Latitud</small></div>'+
										  '<div><b>'+data.latitud+'</b></div>'+
										  '<div><small>Longitud</small></div>'+
										  '<div><b>'+data.longitud+'</b></div>'+
										  '<div class="text-right" id="actGeoreferencial"></div>'
										  );

					if(data.actualizar == true && data.validacion != 1){

						$('#validacionMsg').empty();
						$('#validacionMsg').append('<div style="color:#888888; margin-bottom:5px; padding:2px; border:1px solid #96BDE7" class="text-center"><small>Estado: '+data.validacionMsg+'</small>');

						$('#actGeografica').append('<div style="color:#888888; margin-bottom:5px;" class="text-center"><small>Última fecha de modificación: '+data.fechaModificacionLocalizacion+'</small></div>');
						$('#actGeografica').append('<button class="btn btn-success btn-sm btn-editar" onclick="actualizarGeografica('+data.codEdificio+');" data-container="body" data-toggle="popover" data-placement="top" data-content="Editar Ubicación Geográfica" data-trigger="hover">Editar</button>');

						$('#actGeoreferencial').append('<div style="color:#888888; margin-bottom:5px;" class="text-center"><small>Última fecha de modificación: '+data.fechaModificacionCoordenada+'</small></div>');
						if(data.municipio == 'Ninguno'){
							$('#actGeoreferencial').append('<button class="btn btn-success btn-sm" disabled="disabled">Editar</button>');
						}else{
							$('#actGeoreferencial').append('<button class="btn btn-success btn-sm btn-editar" onclick="actualizarGeoreferencial('+data.codEdificio+', false);" data-container="body" data-toggle="popover" data-placement="top" data-content="Editar Ubicación Georeferencial" data-trigger="hover">Editar</button>');
						}
					}
					if(data.actualizar == true && data.municipio != 'Ninguno' && data.latitud != 'Ninguno'){
						$('#validacionMsg').empty();
						$('#validacionMsg').append('<div style="color:#888888; margin-bottom:5px; padding:2px; border:1px solid #96BDE7" class="text-center"><small>Estado: '+data.validacionMsg+'</small>');

						var ruta = Routing.generate('download_reporte_gis', {'codEdificio': data.codEdificio});
						if (data.validacion == 1) {
							$('#detalle').append('<hr><a href="'+ruta+'" class="btn btn-info btn-block" data-container="body" data-toggle="popover" data-placement="top" data-content="Imprimir reporte" data-trigger="hover"> <i class="fa fa-print"></i> Reporte</a>');
						} else {
							$('#detalle').append('<hr><a href="'+ruta+'" class="btn btn-info btn-block" onclick="return imprimirReporte('+data.codEdificio+');" data-container="body" data-toggle="popover" data-placement="top" data-content="Imprimir reporte" data-trigger="hover"> <i class="fa fa-print"></i> Reporte</a>');
						}
					}

					$('[data-toggle="popover"]').popover();
				},
				error: function(data){
					$('#detalle').empty();
					$('#detalle').append('<div class="alert alert-danger">Error</div>')
				}
			});
		}

		function seleccionarEdificio(i){
			$.ajax({
				type:'post',
				url: Routing.generate('sie_gis_seleccionar_edificio',{'edificio':i}),
				beforeSend: function(){
					$('#detalle').empty();
					$('#detalle').append('<div style="text-align:center; padding:20px 0 20px 0; color:#5DABFB; font-size:13px;"><img src="{{asset("img/loading.gif")}}" width="20px"/> <br> Cargando... </div>');
				},
				success: function(data){
					codigoEdificio = data.codEdificio;
					idComunidad = data.idComunidad;
					idComunidadNext = data.idComunidad;
					codigo = i;
					$('#detalle').empty();
					if(marker){
						marker.setMap(null);
					}
					if(data.coordenadas == true){
					    // Construimos el marcador
					    marker = new google.maps.Marker({
					        position: {lat: data.latitud, lng:data.longitud},
					        map: map,
					        title: 'Edificio Escolar',
					        draggable: false
					    });

					    // Centrar el map
					    map.setCenter(myLatLng);

					    contentString = '<div>Código de Edificio</div>'+
					    				'<b>'+data.codEdificio+'</b>';

					    infowindow = new google.maps.InfoWindow({
					        content: contentString
					    });

					    marker.addListener('click', function() {
					        infowindow.open(map, marker);
					        //map.setCenter({lat: data.latitud, lng:data.longitud});
					    });

					    marker.addListener('dblclick', function() {
					        //map.setZoom(15);
					    });
					}

					map.setZoom(6);

					$('#detalle').append('<h6 style="padding-top:10px"><i class="fa fa-file-text-o"></i> Información</h6>'+
										  '<div><small>Código de Edificio</small></div>'+
										  '<div><b>'+data.codEdificio+'</b></div>'+
										  '<div><small>Zona</small></div>'+
										  '<div><b>'+data.zona+'</b></div>'+
										  '<div><small>Dirección</small></div>'+
										  '<div><b>'+data.direccion+'</b></div>'+
										  '<hr>'+
										  '<h6><i class="fa fa-map-o"></i> Ubicación Geográfica</h6>'+
										  '<div><small>Departamento</small></div>'+
										  '<div class="jupper"><b>'+data.departamento+'</b></div>'+
										  '<div><small>Provincia</small></div>'+
										  '<div class="jupper"><b>'+data.provincia+'</b></div>'+
										  '<div><small>Municipio</small></div>'+
										  '<div class="jupper"><b>'+data.municipio+'</b></div>'+
										  '<div><small>Comunidad</small></div>'+
										  '<div class="jupper"><b>'+data.comunidad+'</b></div>'+
										  '<div class="text-right" id="actGeografica"></div>'+
										  '<hr>'+
										  '<h6> <i class="fa fa-map-marker"></i> Ubicación Georeferencial</h6>'+
										  '<div id="validacionMsg"></div>'+
										  '<div><small>Latitud</small></div>'+
										  '<div><b>'+data.latitud+'</b></div>'+
										  '<div><small>Longitud</small></div>'+
										  '<div><b>'+data.longitud+'</b></div>'+
										  '<div class="text-right" id="actGeoreferencial"></div>'+
										  '<hr>'+
										  '<h6>Unidades Educativas que operan en el Edificio Educativo</h6>'
										  );

					if(data.actualizar == true && data.validacion != 1){
						$('#validacionMsg').empty();
						$('#validacionMsg').append('<div style="color:#888888; margin-bottom:5px; padding:2px; border:1px solid #96BDE7" class="text-center"><small>Estado: '+data.validacionMsg+'</small>');

						$('#actGeografica').append('<div style="color:#888888; margin-bottom:5px;" class="text-center"><small>Última fecha de modificación: '+data.fechaModificacionLocalizacion+'</small></div>');
						$('#actGeografica').append('<button class="btn btn-success btn-sm btn-editar" onclick="actualizarGeografica('+data.codEdificio+');" data-container="body" data-toggle="popover" data-placement="top" data-content="Editar Ubicación Geográfica" data-trigger="hover">Editar</button>');

						$('#actGeoreferencial').append('<div style="color:#888888; margin-bottom:5px;" class="text-center"><small>Última fecha de modificación: '+data.fechaModificacionCoordenada+'</small></div>');
						if(data.municipio == 'Ninguno'){
							$('#actGeoreferencial').append('<button class="btn btn-success btn-sm" disabled="disabled">Editar</button>');
						}else{
							$('#actGeoreferencial').append('<button class="btn btn-success btn-sm btn-editar" onclick="actualizarGeoreferencial('+data.codEdificio+', false);" data-container="body" data-toggle="popover" data-placement="top" data-content="Editar Ubicación Georeferencial" data-trigger="hover">Editar</button>');
						}
					}

					$('#detalle').append('<small><table class="table table-sm table-bordered"><thead><tr class="table-info">'+
										'<th>SIE</th>'+
										'<th>Institución Educativa</th>'+
										'</tr></thead><tbody id="listaues"></tbody></table></small>'
										);
					$.each(data.unidadesEducativas, function(i, value){
        	            $('#listaues').append('<tr><td>'+i+'</td><td>'+value.institucioneducativa+'</td></tr>');
        	        });

        	        if(data.actualizar == true && data.municipio != 'Ninguno' && data.latitud != 'Ninguno'){
        	        	$('#validacionMsg').empty();
						$('#validacionMsg').append('<div style="color:#888888; margin-bottom:5px; padding:2px; border:1px solid #96BDE7" class="text-center"><small>Estado: '+data.validacionMsg+'</small>');

						var ruta = Routing.generate('download_reporte_gis', {'codEdificio': data.codEdificio});

						if (data.validacion == 1) {
							$('#detalle').append('<hr><a href="'+ruta+'" class="btn btn-info btn-block" data-container="body" data-toggle="popover" data-placement="top" data-content="Imprimir reporte" data-trigger="hover"> <i class="fa fa-print"></i> Reporte</a>');
						} else {
							$('#detalle').append('<hr><a href="'+ruta+'" class="btn btn-info btn-block" onclick="return imprimirReporte('+data.codEdificio+');" data-container="body" data-toggle="popover" data-placement="top" data-content="Imprimir reporte" data-trigger="hover"> <i class="fa fa-print"></i> Reporte</a>');
						}
						
					}

					$('[data-toggle="popover"]').popover();

				},
				error: function(data){
					$('#detalle').empty();
					$('#detalle').append('<div class="alert alert-danger">Error</div>')
				}
			});
		}

		function actualizarGeografica(codEdificio){
			$.ajax({
				type: 'post',
				url: Routing.generate('sie_gis_datos_edit_geografica', {'codEdificio':codEdificio}),
				beforeSend: function(){

				},
				success: function(data){
					$('#modal').empty();
					$('#modal').append(data);
					$('#modal').modal('show');
				},
				error: function(data){

				}
			});
		}

		function actualizarGeoreferencial(codEdificio, actuGeo){
			$.ajax({
				type: 'post',
				url: Routing.generate('sie_gis_datos_edit_georeferencial', {'codEdificio':codEdificio}),
				beforeSend: function(){
					$('#numeroPaso').empty();
					$('#msgActualizacion').empty();
					if(actuGeo == true){
						$('#numeroPaso').append('Paso 2: ');
						$('#msgActualizacion').append('<div style="padding:15px; color:#0E434D; background-color:#C7E8EE; border-radius:5px;"><small><i class="fa fa-info-circle"></i> Para completar la edicion debe actualizar las coordenadas.</small></div>');
					}
				},
				success: function(data){
					/* Asignamos el valor de las coordenadas */

					actualizarGeo = actuGeo;

					$('.latitud').empty();
					$('.latitud').text(data.latitud);
					$('.longitud').empty();
					$('.longitud').text(data.longitud);
					$('.coordenadasCodEdificio').empty();
					$('.coordenadasCodEdificio').text(data.codEdificio);

					codigoEdificio = data.codEdificio;

					/* Mostramos el div de actualizacion de coordenadas y ocultamos el menu*/

					$('.coordenadas').fadeIn();
					$('.menu').fadeOut(400);
					$('.btn-menu').fadeOut(400);

					/* Asignamos las variables */

					latitudPreview = data.latitud;
					longitudPreview = data.longitud;

					latitud = data.latitud;
					longitud = data.longitud;

					/* Creamos el poligono */

					poligono = new google.maps.Polygon({
				        paths: data.cordsPoligono,
				        strokeColor: '#FF0000',
				        strokeOpacity: 0.4,
				        strokeWeight: 2,
				        fillColor: '#FF0000',
				        fillOpacity: 0
				    });
				    poligono.setMap(map);

				    /*  eliminamos el marcador previo */
				    if(marker){marker.setMap(null);}

				    if(latitudPreview == 'Ninguno' || longitudPreview == 'Ninguno'){
				    	//var posicionMarcador = {lat:-16.76031273193217, lng:-64.56658868750003};
				    	var posicionMarcador = {lat: data.latitudMunicipio, lng: data.longitudMunicipio};
				    	map.setCenter({lat: data.latitudMunicipio, lng: data.longitudMunicipio});
				    	//map.setCenter({lat:-16.76031273193217, lng:-64.56658868750003});
			    		map.setZoom(6);

			    		$('.latitud').empty();
			    		$('.latitud').text(data.latitudMunicipio);
			    		$('.longitud').empty();
			    		$('.longitud').text(data.longitudMunicipio);
				    }else{
				    	var posicionMarcador = {lat:latitud, lng:longitud};
				    	map.setCenter({lat:latitud, lng:longitud});
				    }

			    	/* Creamos un marcador */
			    	marker = new google.maps.Marker({
			    	    position: posicionMarcador,
			    	    map: map,
			    	    title: 'Edificio Escolar',
			    	    draggable: true
			    	});

			    	contentString = '<div>Código de Edificio</div>'+
			    					'<b>'+data.codEdificio+'</b>';

			    	infowindow = new google.maps.InfoWindow({
			    	    content: contentString
			    	});

			    	marker.addListener('click', function() {
			    	    infowindow.open(map, marker);
			    	    //map.setCenter({lat: data.latitud, lng:data.longitud});
			    	    //map.setZoom(12);
			    	});

			    	marker.addListener('dblclick', function() {
				        //map.setZoom(15);
				    });

			    	marker.addListener('dragstart', function() {
			    	    console.log('Empezando');
			    	    infowindow.close();
			    	});
			    	marker.addListener('drag', function() {
			    	    validarPosicion();
			    	    $('.latitud').text(marker.getPosition().lat());
			    	    $('.longitud').text(marker.getPosition().lng());
			    	    latitud = marker.getPosition().lat();
			    	    longitud = marker.getPosition().lng();
			    	});
			    	marker.addListener('dragend', function() {
			    	    console.log('soltado en LAT:'+marker.getPosition().lat()+' LON:'+marker.getPosition().lng());
			    	});
				    
				},
				error: function(data){
					alert('error');
				}
			});
		}

		function ingresarCoordenadas(){
			$('#bLatitud').val('');
			$('#bLongitud').val('');
			$('#modal2').modal('show');
		}

		function buscarCoordenadas(){
			var bLatitud = $('#bLatitud').val();
			var bLongitud = $('#bLongitud').val();
			if(bLatitud != "" && bLongitud != ""){
				var latlng = new google.maps.LatLng(bLatitud, bLongitud);
    			marker.setPosition(latlng);
    			map.setZoom(6);
    			latitud = bLatitud;
    			longitud = bLongitud;
    			$('.latitud').empty();
    			$('.longitud').empty();
    			$('.latitud').text(bLatitud);
    			$('.longitud').text(bLongitud);
    			$('#modal2').modal('hide');
			}else{
    			$.notifyClose();
				$.notify({
					icon: 'fa fa-check',
					message: 'Debe registrar las coordenadas'
				},{
					type: 'warning'
				});
			}
		}

		function cerrarGeoreferencial(){
			idComunidadNext = idComunidad;
			actualizarGeo = false;
			$('.coordenadas').fadeOut(200);
			if(latitudPreview == 'Ninguno' || longitudPreview == 'Ninguno'){
				if(marker){marker.setMap(null);}
				map.setCenter({lat:-16.76031273193217, lng:-64.56658868750003});
				//map.setZoom(6);
			}else{
				marker.setPosition({lat: latitudPreview, lng: longitudPreview});
				marker.setDraggable(false);
				map.setCenter({lat: latitudPreview, lng: longitudPreview});
				//map.setZoom(6);
			}
			if (poligono) {poligono.setMap(null);}
			mostrarMenu();
		}

		function updateGeoreferencial(){
	    	$.ajax({
	    		type: 'post',
	    		url: Routing.generate('sie_gis_datos_update_georeferencial',{'codEdificio' : codigoEdificio, 'latitud':marker.getPosition().lat(), 'longitud':marker.getPosition().lng(),'idComunidad': idComunidadNext, 'actualizarGeografica': actualizarGeo}),
	    		beforeSend: function(){
					var latlng = new google.maps.LatLng(latitud, longitud);
	    			marker.setPosition(latlng);
	    		},
	    		success: function(data){
	    			if (data.status == 200) {

	    				idComunidad = idComunidadNext;

		    			console.log('Guardado');
		    			if(tipoBusqueda == 'edificio'){
		    				seleccionarEdificio(codigo);
		    			}else{
		    				seleccionarUnidad(codigo);
		    			}
		    			cerrarGeoreferencial();
		    			$.notifyClose();
						$.notify({
							icon: 'fa fa-check',
							message: data.msg
						},{
							type: 'success'
						});
	    			} else {
		    			$.notifyClose();
						$.notify({
							icon: 'fa fa-check',
							message: data.msg
						},{
							type: 'warning'
						});
	    			}
	    		},
	    		error: function(data){
	    			$.notifyClose();
					$.notify({
						icon: 'fa fa-warning',
						message: 'Ocurrio un error, actualización no realizada.'
					},{
						type: 'danger'
					});
	    		}
	    	});
		}

		var peticion1;
        //$('#form_turno').on('change',function(){
        function listarProvincias(idDpto) {
            if (peticion1 && peticion1.readyState != 4) {
                peticion1.abort();
            }

            peticion1 = $.ajax({
                type: 'get',
                url: Routing.generate('sie_gis_listar_provincias', {'dpto': idDpto}),
                beforeSend: function () {

                },
                success: function (data) {
                    $('#form_provincia').empty();
                    $('#form_municipio').empty();
                    $('#form_comunidad').empty();
                    $("#form_provincia").append('<option value="">Seleccionar...</option>');
                    $("#form_municipio").append('<option value="">Seleccionar...</option>');
                    $("#form_comunidad").append('<option value="">Seleccionar...</option>');
                    $.each(data.listaprovincias, function (i, value) {
                        $("#form_provincia").append('<option value="' + i + '">' + value + '</option>');
                    });
                }
            });
        }
        
        var peticion2;
        //$('#form_turno').on('change',function(){
        function listarMunicipios(idProv) {
            if (peticion2 && peticion2.readyState != 4) {
                peticion2.abort();
            }

            peticion2 = $.ajax({
                type: 'get',
                url: Routing.generate('sie_gis_listar_municipios', {'prov': idProv}),
                beforeSend: function () {

                },
                success: function (data) {
                    $('#form_municipio').empty();
                    $('#form_comunidad').empty();
                    $("#form_municipio").append('<option value="">Seleccionar...</option>');
                    $("#form_comunidad").append('<option value="">Seleccionar...</option>');
                    $.each(data.listamunicipios, function (i, value) {
                        $("#form_municipio").append('<option value="' + i + '">' + value + '</option>');
                    });
                }
            });
        }
        
        var peticion3;
        //$('#form_turno').on('change',function(){
        function listarComunidades(idMuni) {
            if (peticion3 && peticion3.readyState != 4) {
                peticion3.abort();
            }

            peticion3 = $.ajax({
                type: 'get',
                url: Routing.generate('sie_gis_listar_comunidades', {'mun': idMuni}),
                beforeSend: function () {

                },
                success: function (data) {
                    $('#form_comunidad').empty();
                    $("#form_comunidad").append('<option value="">Seleccionar...</option>');
                    $.each(data.listacomunidades, function (i, value) {
                        $("#form_comunidad").append('<option value="' + i + '">' + value + '</option>');
                    });
                }
            });
        }

        function imprimirReporte(codEdificio){
        	if (confirm('Al generar este reporte usted no podra realizar mas modificaciones de la Ubicación Geográfica y de la Ubicación Georeferencial, verifique la información.\n¿Esta seguro de generar el reporte? Presione aceptar para continuar.')) {
	        	$.notifyClose();
				$.notify({
					icon: 'fa fa-info-circle',
					message: 'Generando Reporte...'
				},{
					type: 'info'
				});

				$('.btn-editar').css('display','none');
				$('#validacionMsg').empty();
				$('#validacionMsg').append('<div style="color:#888888; margin-bottom:5px; padding:2px; border:1px solid #96BDE7" class="text-center"><small>Estado: Coordenada validada en operativo</small>');
				return true;
        	}

        	return false;
        }

	</script>
</body>
</html>