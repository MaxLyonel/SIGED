{% extends 'layoutRegular.html.twig' %}
{% block stylesheets %}
    {{parent()}}
    <link href="{{asset('css/chosen.css')}}" rel="stylesheet">

{% endblock %}
{% block contentoption %}

    <div class="row">
        <div class="col-lg-12">
            <div class="page-title">
                <h1>{{ app.session.get('tituloTipo') }}
                    <small>Adición/Eliminación</small>
                </h1>
                <ol class="breadcrumb">
                    <li><i class="fa fa-search"></i>  <a href="{{path('areas_estudiante')}}">Buscar</a></li>
                    <li><i class="fa fa-list"></i>  <a href="{{path('areas_estudiante',{'op':'result'})}}">{{ app.session.get('tituloTipo') }}</a>
                    </li>
                </ol>
            </div>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <div class="row">
        <div class="col-md-12">
            {% for flashMessage in app.session.flashbag.get('newError') %}
                <div class="alert alert-danger" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
            {% for flashMessage in app.session.flashbag.get('updateOk') %}
                <div class="alert alert-success" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
            {% for flashMessage in app.session.flashbag.get('updateError') %}
                <div class="alert alert-danger" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
            {% for flashMessage in app.session.flashbag.get('deleteOk') %}
                <div class="alert alert-success" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
            {% for flashMessage in app.session.flashbag.get('deleteError') %}
                <div class="alert alert-danger" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
            <!--  cursos -->
            {% for flashMessage in app.session.flashbag.get('newCursoOk') %}
                <div class="alert alert-success" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
            {% for flashMessage in app.session.flashbag.get('newCursoError') %}
                <div class="alert alert-danger" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
            {% for flashMessage in app.session.flashbag.get('deleteCursoOk') %}
                <div class="alert alert-success" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
            {% for flashMessage in app.session.flashbag.get('deleteCursoError') %}
                <div class="alert alert-danger" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flashMessage }}
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="portlet portlet-{{ app.session.get('sysporlet') }}">
                <div class="portlet-heading">
                    <div class="portlet-title">
                        <h4>Institución Educativa</h4>
                    </div>
                    <div class="portlet-widgets">
                        <a data-toggle="collapse" data-parent="#accordion" href="basic-form-elements.html#panelinstitucion"><i class="fa fa-chevron-down"></i></a>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div id="panelinstitucion" class="panel-collapse collapse in">
                    <div class="portlet-body">
                        <div class="panel-body panel-primary">
                            <div id="no-more-tables">
                                <table class="table table-bordered cf">
                                    <thead class="cf">
                                        <tr>
                                            <th>Código SIE</th>
                                            <th>Nombre</th>
                                            <th>Gestión</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <td data-title="Código SIE">{{institucion.id}}</td>
                                    <td data-title="Ins.Educativa">{{institucion.institucioneducativa}}</td>
                                    <td data-title="Gestión">{{gestion}}</td>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="background: #EEE; padding:3px 10px 10px 10px">
                                <h4 class="text-orange">Seleccionar curso</h4>
                                {{form_start(form,{'attr':{'id':'formAreas','onsubmit':'return validateForm()'} })}}
                                    <div class="row">
                                        <div class="col-lg-3 col-md-6">
                                            {{form_label(form.turno)}}
                                            {{form_widget(form.turno)}}
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            {{form_label(form.nivel)}}
                                            {{form_widget(form.nivel)}}
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            {{form_label(form.grado)}}
                                            {{form_widget(form.grado)}}
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            {{form_label(form.paralelo)}}
                                            {{form_widget(form.paralelo)}}
                                        </div>
                                        <div class="col-lg-4 col-lg-offset-4" style="text-align:center">
                                            <br>
                                            {{form_widget(form.buscar)}}
                                        </div>
                                    </div>
                                {{form_end(form)}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 
    
    <div class="row">
        <div class="col-lg-12">
            <div class="portlet portlet-blue">
                <div class="portlet-heading">
                    <div class="portlet-title">
                        <h4>Lista de estudiantes inscritos</h4>
                    </div>
                    <div class="portlet-widgets">
                        <a data-toggle="collapse" href="basic-form-elements.html#panelAreas"><i class="fa fa-chevron-down"></i></a>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div id="panelAreas" class="panel-collapse collapse in">
                    <div class="portlet-body">
                        <div id="divMensaje"></div>
                        <div id="divAreas">
                            Debe seleccionar un curso
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal modal-flex fade" id="newModal" tabindex="-1" role="dialog" aria-labelledby="flexModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <form name="formAreasModal" id="formAreasModal" action="" onsubmit="enviarAreas(); return false">
                    <input type="hidden" name="divResultado" id="divResultado">
                    <input type="hidden" name="idInstitucionCurso" id="idInstitucionCurso">
                    <input type="hidden" name="idNivel" id="idNivel">
                    <input type="hidden" name="idEstudianteInscripcion" id="idEstudianteInscripcion">
                    <input type="hidden" name="educacionTipo" id="educacionTipo" value="{{app.session.get('sysname')}}">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title" id="flexModalLabel">Adición de areas </h4>
                        <span id="nivelModal"></span>
                         - <span id="gradoModal"></span>
                         - <span id="paraleloModal"></span>
                         <br>
                        <span id="nameEstudentA" style="color: #7EFF0E;"></span>
                    </div>
                    <div class="modal-body">                        
                        <div id="areasModal">
                            
                        </div>
                    </div>
                    <div class="modal-footer">
                        
                    </div>
                </form>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>



    <div class="modal modal-flex fade" id="newModalNotas" tabindex="-1" role="dialog" aria-labelledby="flexModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <form name="formNotasModal" id="formNotasModal" action="" onsubmit="registrarNotas(); return false">
                    <input type="hidden" name="divResultado" id="divResultado">
                    <input type="hidden" name="idInstitucionCurso" id="idInstitucionCurso">
                    <input type="hidden" name="idNivel" id="idNivel">
                    <input type="hidden" name="idEstudianteInscripcion" id="idEstudianteInscripcion">
                    <input type="hidden" name="educacionTipo" id="educacionTipo" value="{{app.session.get('sysname')}}">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title" id="flexModalLabel">Registro de Calificaciones</h4>
                        <span id="nameEstudent" style="color:#7EFF0E;"></span>
                    </div>
                    <div class="modal-body">
                        <div id="areasSinNotas">
                            
                        </div>
                    </div>
                    <div class="modal-footer">
                        
                    </div>
                </form>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

{% endblock %}
{% block javascripts %}
    {{parent()}}
    <script src="{{asset('js/chosen.jquery.js')}}"></script>
    <script>
        var xhr2;
        var xhr3;
        var xhr4;
        function cargarNiveles() {
            var institucion = $('#form_idInstitucion').val();
            var gestion = $('#form_idGestion').val();
            var turno = $('#form_turno').val();
            if(xhr2 && xhr2.readyState != 4){
                xhr2.abort();
            }
            xhr2 = $.ajax({
                type: 'get',
                url: Routing.generate('areas_estudiante_cargar_niveles', {'idInstitucion': institucion,'gestion':gestion,'turno':turno}),
                beforeSend: function () {
                    $("#form_nivel").empty();
                    $("#form_grado").empty();
                    $("#form_paralelo").empty();
                    $("#form_nivel").append('<option value="">Buscando...</option>');
                    $("#form_grado").append('<option value="">Buscando...</option>');
                    $("#form_paralelo").append('<option value="">Buscando...</option>');
                },
                success: function (data) {
                    $("#form_nivel").empty();
                    $("#form_grado").empty();
                    $("#form_paralelo").empty();
                    $("#form_nivel").append('<option value="">Seleccionar...</option>');
                    $("#form_grado").append('<option value="">Seleccionar...</option>');
                    $("#form_paralelo").append('<option value="">Seleccionar...</option>');
                    $.each(data.niveles, function (i, value) {
                        $("#form_nivel").append('<option value="' + i + '">' + value + '</option>');
                    });
                }
            });
        }
        function cargarGrados() {
            var institucion = $('#form_idInstitucion').val();
            var gestion = $('#form_idGestion').val();
            var turno = $('#form_turno').val();
            var nivel = $('#form_nivel').val();
            if(xhr3 && xhr3.readyState != 4){
                xhr3.abort();
            }
            xhr3 = $.ajax({
                type: 'get',
                url: Routing.generate('areas_estudiante_cargar_grados', {'idInstitucion': institucion,'gestion':gestion,'turno':turno,'nivel':nivel}),
                beforeSend: function () {
                    $("#form_grado").empty();
                    $("#form_paralelo").empty();
                    $("#form_grado").append('<option value="">Buscando...</option>');
                    $("#form_paralelo").append('<option value="">Buscando...</option>');
                },
                success: function (data) {
                    $("#form_grado").empty();
                    $("#form_paralelo").empty();
                    $("#form_grado").append('<option value="">Seleccionar...</option>');
                    $("#form_paralelo").append('<option value="">Seleccionar...</option>');
                    $.each(data.grados, function (i, value) {
                        $("#form_grado").append('<option value="' + i + '">' + value + '</option>');
                    });
                }
            });
        }
        function cargarParalelos() {
            var institucion = $('#form_idInstitucion').val();
            var gestion = $('#form_idGestion').val();
            var turno = $('#form_turno').val();
            var nivel = $('#form_nivel').val();
            var grado = $('#form_grado').val();
            if(xhr4 && xhr4.readyState != 4){
                xhr4.abort();
            }
            xhr4 = $.ajax({
                type: 'get',
                url: Routing.generate('areas_estudiante_cargar_paralelos', {'idInstitucion': institucion,'gestion':gestion,'turno':turno,'nivel':nivel,'grado':grado}),
                beforeSend: function () {
                    $("#form_paralelo").empty();
                    $("#form_paralelo").append('<option value="">Buscando...</option>');
                },
                success: function (data) {
                    $("#form_paralelo").empty();
                    $("#form_paralelo").append('<option value="">Seleccionar...</option>');
                    $.each(data.paralelos, function (i, value) {
                        $("#form_paralelo").append('<option value="' + i + '">' + value + '</option>');
                    });
                }
            });
        }

        var xhr1;
        function validateForm(){
            var turno = $('#form_turno').val();
            var nivel = $('#form_nivel').val();
            var grado = $('#form_grado').val();
            var paralelo = $('#form_paralelo').val();
            if(turno == ''){ alert('Debe seleccionar un turno'); return false; }
            if(nivel == ''){ alert('Debe seleccionar un nivel'); return false; }
            if(grado == ''){ alert('Debe seleccionar un grado'); return false; }
            if(paralelo == ''){ alert('Debe seleccionar un paralelo'); return false; }

            if(xhr1 && xhr1.readyState != 4){
                xhr1.abort();
            }

            var formData = $('#formAreas').serialize();
            $.ajax({
                type: 'get',
                url: Routing.generate('areas_estudiante_listar_estudiantes_curso'),
                data: formData,
                beforeSend: function () {
                    $("#divAreas").empty();
                    $("#divAreas").append("<div style='text-align:center'><img src='{{asset('img/loading.gif')}}'></div>");
                },
                success: function (data) {
                    $("#divAreas").empty();
                    $("#divAreas").append(data);
                    $("#tablaEstudiantes").addClass("dataTable");
                },
                error: function(data){
                    $("#divAreas").empty();
                    $("#divAreas").append('<div class="alert alert-danger"><i class="glyphicon glyphicon-exclamation-sign"></i> El curso no existe o no hay conexion con el servidor</div>');
                }
            });
            return false;
        }

        function mostrarAreas(nivel,grado,paralelo,idInstitucionCurso,idNivel,divResultado,idEstudianteInscripcion, nombreEstudiante){
            $('#nivelModal').empty();$('#nivelModal').append((nivel));
            $('#gradoModal').empty();$('#gradoModal').append(grado);
            $('#paraleloModal').empty();$('#paraleloModal').append(paralelo);
            
            $('#divResultado').empty();$('#divResultado').val(divResultado);
            $('#idInstitucionCurso').empty();$('#idInstitucionCurso').val(idInstitucionCurso);
            $('#idNivel').empty();$('#idNivel').val(idNivel);
            $('#idEstudianteInscripcion').empty();$('#idEstudianteInscripcion').val(idEstudianteInscripcion);
            $('#nameEstudentA').empty();$('#nameEstudentA').append(nombreEstudiante);

            $.ajax({
                type: 'get',
                url: Routing.generate('areas_estudiante_listar_areas_nivel',{'idNivel': idNivel,'idCurso': idInstitucionCurso,'idEstudianteInscripcion':idEstudianteInscripcion }),
                beforeSend: function () {
                    $("#areasModal").empty();
                    $("#areasModal").append("<div style='text-align:center'><img src='{{asset('img/loading.gif')}}'></div>");
                },
                success: function (data) {
                    $("#areasModal").empty();
                    $("#areasModal").append(data);
                },
                error: function(){
                    $("#areasModal").empty();
                    $("#areasModal").append('<div class="alert alert-warning"><i class="fa fa-warning"></i> No se puden mostrar los datos.</div>');
                }
            });
            $('#newModal').modal('show');
        }

        function marcarTodasAreas(){
            var marcar = document.getElementById('marcarTodos');
            var areas = document.getElementsByName('areas[]');
            if(marcar.checked){
                for (var i=0; i < areas.length; i++){
                    areas[i].checked = true;
                }
            }else{
                for (var i=0; i < areas.length; i++){
                    if(areas[i].disabled != true){
                        areas[i].checked = false;
                    }
                }
            }
        }

        function enviarAreas(){
            var educacionTipo = $('#educacionTipo').val();
            var nivel = $('#idNivel').val();
            if(educacionTipo!= 'REGULAR'){
                var marcados = 'si';
                var areas = document.getElementsByName('areas[]');
                for (var i=0; i < areas.length; i++){
                    if(!areas[i].checked){
                        marcados = 'no';
                    }
                }
                if(marcados == 'no'){
                    alert('Debe seleccionar todas las areas.');
                    return 0;
                }
            }
            
            
            var div = $('#divResultado').val();
            var formData = $('#formAreasModal').serialize();
            $.ajax({
                type: 'get',
                url: Routing.generate('areas_estudiante_listar_areas_estudiante_adicionar_eliminar'),
                data: formData,
                beforeSend: function () {
                    //$("#divAreas").append("<div style='text-align:center'><img src='{{asset('img/loading.gif')}}'></div>");
                },
                success: function (data) {
                    $('#'+data.span).empty();
                    $('#'+data.span).append(data.cantidadAsignaturas);
                },
                error: function(data){
                    alert('No se puede agregar y eliminar las areas');
                }
            });
            $('#newModal').modal('hide');
        }

        /*  funciones para agregar notas */
        function modalNotas(nivel,grado,paralelo,idInstitucionCurso,idNivel,divResultado,idEstudianteInscripcion,nombreEstudiante){
            $('#idNivel').empty();$('#idNivel').val(idNivel);
            $('#idEstudianteInscripcion').empty();$('#idEstudianteInscripcion').val(idEstudianteInscripcion);
            $('#nameEstudent').empty();$('#nameEstudent').append(nombreEstudiante);
            $.ajax({
                type: 'get',
                url: Routing.generate('areas_estudiante_listar_areas_sin_notas',{'idEstudianteInscripcion':idEstudianteInscripcion,'idNivel':idNivel }),
                beforeSend: function () {
                    $("#areasSinNotas").empty();
                    $("#areasSinNotas").append("<div style='text-align:center'><img src='{{asset('img/loading.gif')}}'></div>");
                },
                success: function (data) {
                    $("#areasSinNotas").empty();
                    $("#areasSinNotas").append(data);
                },
                error: function(){
                    $("#areasSinNotas").empty();
                    $("#areasSinNotas").append('<div class="alert alert-warning"><i class="fa fa-warning"></i> No se puden mostrar los datos.</div>');
                }
            });
            $('#newModalNotas').modal('show');
        }

        function registrarNotas(){
            var nivel = $('#idNivel').val();
            
            var div = $('#divResultado').val();
            var formData = $('#formNotasModal').serialize();
            $.ajax({
                type: 'get',
                url: Routing.generate('areas_estudiante_registrar_notas'),
                data: formData,
                beforeSend: function () {
                    //$("#divAreas").append("<div style='text-align:center'><img src='{{asset('img/loading.gif')}}'></div>");
                },
                success: function (data) {
                    /* Borrar los mensajes de notificacion */
                    Messenger().hideAll();
                    /* crear nuevo mensaje de encontrado */
                    Messenger.options = {
                        extraClasses: 'messenger-fixed messenger-on-bottom messenger-on-right',
                        theme: 'flat'
                    }

                    Messenger().post({
                        message: 'Las calificaciones se registraron correctamente',
                        id: "Only-one-message",
                        type: 'success',
                        showCloseButton: true
                    });
                },
                error: function(data){
                    alert('No se pueden registrar las calificaciones');
                }
            });
            $('#newModalNotas').modal('hide');
        }
    </script>
{% endblock %}